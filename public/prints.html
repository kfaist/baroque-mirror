<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shop Prints - Baroque Mirror</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: #0a0608; 
            color: #fff; 
            font-family: 'Cormorant Garamond', Georgia, serif; 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .content { position: relative; z-index: 10; }
        
        .header { 
            text-align: center; 
            padding: 20px; 
            border-bottom: 1px solid rgba(212,175,55,0.3); 
            background: linear-gradient(180deg, rgba(114,47,55,0.4) 0%, rgba(10,6,8,0.9) 100%);
            backdrop-filter: blur(10px);
        }
        
        .header-top { 
            display: flex; 
            justify-content: center; 
            gap: 40px; 
            margin-bottom: 10px; 
            font-size: 0.8rem; 
            letter-spacing: 4px; 
            color: #f4e4ba; 
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
        }
        
        .header h1 { 
            color: #d4af37; 
            font-size: 2.5rem; 
            margin: 0; 
            letter-spacing: 6px; 
            font-family: 'Cinzel', serif;
            text-shadow: 0 0 30px rgba(212,175,55,0.5);
        }
        
        .header-sub { 
            font-size: 1rem; 
            color: rgba(244,228,186,0.8); 
            margin-top: 8px; 
            font-style: italic;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 15px;
            color: #d4af37;
            text-decoration: none;
            font-family: 'Cinzel', serif;
            letter-spacing: 2px;
            padding: 8px 20px;
            border: 1px solid rgba(212,175,55,0.4);
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            background: rgba(212,175,55,0.2);
            box-shadow: 0 0 20px rgba(212,175,55,0.3);
        }
        
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .section-title {
            text-align: center;
            color: #d4af37;
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            letter-spacing: 4px;
            margin-bottom: 25px;
        }
        
        /* Captures Grid */
        .no-captures {
            text-align: center;
            padding: 40px 20px;
            color: rgba(244,228,186,0.7);
            font-size: 1.1rem;
        }
        
        .no-captures a { color: #d4af37; }
        
        .captures-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
            justify-content: center;
        }
        
        .capture-card {
            background: rgba(15,10,12,0.85);
            border: 2px solid rgba(212,175,55,0.3);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            width: 220px;
        }
        
        .capture-card:hover, .capture-card.selected {
            border-color: #d4af37;
            box-shadow: 0 0 25px rgba(212,175,55,0.3);
            transform: translateY(-3px);
        }
        
        .capture-card.selected {
            box-shadow: 0 0 35px rgba(212,175,55,0.5);
        }
        
        .capture-card .image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 3/2;
            overflow: hidden;
            cursor: grab;
            transition: aspect-ratio 0.4s ease;
            background: #0a0608;
        }
        
        .capture-card .image-container:active {
            cursor: grabbing;
        }
        
        .capture-card.is-sample .image-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            background: url('/wonderball-watermark.png') center/contain no-repeat;
            opacity: 0.5;
            pointer-events: none;
            z-index: 10;
        }
        
        .capture-card img {
            position: absolute;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            max-width: none;
            object-fit: cover;
            display: block;
            user-select: none;
            -webkit-user-drag: none;
            transition: transform 0.2s ease;
        }
        
        .drag-hint {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #d4af37;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
            z-index: 20;
        }
        
        .capture-card:hover .drag-hint,
        .capture-card.selected .drag-hint {
            opacity: 1;
        }
        
        .capture-card.dragging .drag-hint {
            opacity: 0;
        }
        
        /* Size indicator badge */
        .size-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(212,175,55,0.95);
            color: #0a0608;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            letter-spacing: 1px;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-transform: uppercase;
        }
        
        .capture-card.has-size .size-badge {
            opacity: 1;
        }
        
        .capture-label {
            padding: 10px;
            text-align: center;
            color: #f4e4ba;
            font-size: 0.9rem;
            border-top: 1px solid rgba(212,175,55,0.2);
        }
</style>
</head>
<body>
    <div class="content">
        <div class="header">
            <div class="header-top">
                <span>Est. MMXXIV</span>
                <span>‚Ä¢</span>
                <span>Gicl√©e Prints</span>
            </div>
            <h1>Shop Prints</h1>
            <div class="header-sub">Museum-quality prints of your AI portrait</div>
            <a href="/" class="back-link">‚Üê Back to Mirror</a>
        </div>
        
        <div class="main">
            <div id="capturesContainer"></div>
            
            <div id="selectionReminder" class="selection-reminder">
                ‚Üë Select a portrait above to purchase
            </div>
            
            <div class="products-section">
                <h2 class="section-title">‚öú Available Print Options ‚öú</h2>
                <div id="categoriesContainer" class="categories-container"></div>
            </div>
        </div>
    </div>
        
        /* Category Grid */
        .categories-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 900px) {
            .categories-container { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 500px) {
            .categories-container { grid-template-columns: 1fr; }
        }
        
        .category-box {
            background: rgba(15,10,12,0.9);
            border: 1px solid rgba(212,175,55,0.4);
            border-radius: 10px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .category-box:hover {
            border-color: #d4af37;
            background: rgba(212,175,55,0.08);
        }
        
        .category-box.active {
            border-color: #d4af37;
            border-width: 2px;
            background: linear-gradient(180deg, rgba(212,175,55,0.2) 0%, rgba(212,175,55,0.08) 100%);
            box-shadow: 0 0 30px rgba(212,175,55,0.3), inset 0 0 20px rgba(212,175,55,0.1);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-color: transparent;
        }
        
        .category-box.active::after {
            content: '‚ñº';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            color: #d4af37;
            font-size: 0.7rem;
            text-shadow: 0 0 10px rgba(212,175,55,0.8);
        }
        
        .category-name {
            color: #d4af37;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }
        
        .category-box.active .category-name {
            text-shadow: 0 0 15px rgba(212,175,55,0.6);
        }
        
        .category-tagline {
            color: rgba(244,228,186,0.7);
            font-size: 0.85rem;
            font-style: italic;
        }
        
        .category-price {
            color: #f4e4ba;
            font-size: 1.1rem;
            margin-top: 10px;
            font-weight: 600;
        }
        
        /* Dropdown panel */
        .dropdown-panel {
            display: none;
            grid-column: 1 / -1;
            background: linear-gradient(180deg, rgba(212,175,55,0.12) 0%, rgba(10,6,8,0.95) 15%);
            border: 2px solid #d4af37;
            border-top: none;
            border-radius: 0 0 12px 12px;
            margin-top: -15px;
            margin-bottom: 15px;
            overflow: hidden;
            animation: slideDown 0.25s ease;
        }
        
        .dropdown-panel.open {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }
        
        .dropdown-header {
            background: rgba(212,175,55,0.15);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(212,175,55,0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .dropdown-icon {
            font-size: 1.5rem;
            color: #d4af37;
        }
        
        .dropdown-title {
            color: #d4af37;
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(212,175,55,0.4);
        }
        
        .dropdown-desc {
            color: rgba(244,228,186,0.85);
            font-size: 0.9rem;
            margin-top: 4px;
        }
        
        .products-list {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .product-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20,15,18,0.8);
            border: 1px solid rgba(212,175,55,0.25);
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .product-option:hover {
            border-color: #d4af37;
            background: rgba(212,175,55,0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .product-option.selected-size {
            border-color: #d4af37;
            border-width: 2px;
            background: rgba(212,175,55,0.25);
            box-shadow: 0 0 20px rgba(212,175,55,0.4);
        }
        
        .product-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .product-option.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .product-details { flex: 1; }
        
        .product-name {
            color: #f4e4ba;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .product-subtitle {
            color: rgba(244,228,186,0.6);
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        .product-price {
            color: #d4af37;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Cinzel', serif;
        }
        
        /* Selection reminder */
        .selection-reminder {
            text-align: center;
            padding: 15px;
            color: rgba(244,228,186,0.6);
            font-style: italic;
            display: none;
        }
        
        .selection-reminder.show { display: block; }
        
        /* Confirm purchase button */
        .confirm-section {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .confirm-section.show {
            display: block;
        }
        
        .confirm-btn {
            background: linear-gradient(180deg, #d4af37 0%, #a8872a 100%);
            color: #0a0608;
            border: none;
            padding: 15px 40px;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(212,175,55,0.4);
        }
        
        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(212,175,55,0.6);
        }
        
        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .confirm-details {
            margin-top: 10px;
            color: rgba(244,228,186,0.8);
            font-size: 0.95rem;
        }
        
        /* Processing state */
        .processing {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .processing::after {
            content: ' Processing...';
            color: #d4af37;
        }
    </style>

            <div id="confirmSection" class="confirm-section">
                <button class="confirm-btn" onclick="confirmPurchase()">Confirm & Checkout</button>
                <div class="confirm-details" id="confirmDetails"></div>
            </div>
        </div>
    </div>

<script>
const API_BASE = 'https://api-production-d80a.up.railway.app';

let catalog = [];
let selectedCapture = null;
let selectedSlot = null;
let activeCategory = null;
let selectedProduct = null;
let selectedAspectRatio = null;

// Map product sizes to aspect ratios
const SIZE_ASPECTS = {
    // Standard print sizes
    '4x6': 6/4,
    '5x7': 7/5,
    '8x10': 10/8,
    '8x8': 1,
    '10x8': 10/8,
    '11x14': 14/11,
    '12x12': 1,
    '12x16': 16/12,
    '16x16': 1,
    '16x20': 20/16,
    '18x24': 24/18,
    '20x16': 20/16,
    '24x24': 1,
    '24x36': 36/24,
    '30x40': 40/30,
    // A-sizes
    'a6': 148/105,
    'a5': 210/148,
    'a4': 297/210,
    'a3': 420/297,
};

function parseAspectFromProduct(product) {
    // Try to extract dimensions from product name/subtitle
    const text = (product.subtitle || product.name || '').toLowerCase();
    
    // Match patterns like "8√ó10", "8x10", "8 x 10", etc.
    const match = text.match(/(\d+)\s*[√óx]\s*(\d+)/i);
    if (match) {
        const w = parseInt(match[1]);
        const h = parseInt(match[2]);
        return h / w; // height/width for CSS aspect-ratio
    }
    
    // Check for A-sizes
    const aMatch = text.match(/\ba(\d)\b/i);
    if (aMatch) {
        const key = 'a' + aMatch[1];
        if (SIZE_ASPECTS[key]) return SIZE_ASPECTS[key];
    }
    
    // Default landscape ratio
    return 3/2;
}

const CATEGORY_ICONS = {
    'stationery': '‚úâ',
    'prints': 'üñº',
    'premium-paper': 'üìú',
    'canvas': 'üé®',
    'framed': 'üñΩ',
    'acrylic': 'üíé',
    'metal': '‚öô',
    'museum': 'üèõ'
};

const CATEGORY_INFO = {
    'stationery': 'Premium card stock with envelopes included.',
    'prints': 'Acid-free archival paper with 100+ year color guarantee. Ready to frame.',
    'premium-paper': 'Museum-grade substrates for discerning collectors. Cotton rag & specialty textures.',
    'canvas': 'Hand-stretched over solid pine frames, gallery-wrapped edges. Ready to hang.',
    'framed': 'Handmade ash wood frames with conservation mounts and Perspex glaze.',
    'acrylic': 'Face-mounted on 10mm high-gloss perspex with invisible floating mount.',
    'metal': 'ChromaLuxe¬Æ HD aluminum. Dye-sublimated, scratch-resistant, vivid colors.',
    'museum': 'Limited collector editions with hand-gilded frames and Tru Vue¬Æ museum glass.'
};

async function loadCatalog() {
    try {
        const res = await fetch(`${API_BASE}/catalog`);
        catalog = await res.json();
        renderCategories();
    } catch (e) {
        console.error('Failed to load catalog:', e);
        renderFallbackCategories();
    }
}

function renderCategories() {
    const container = document.getElementById('categoriesContainer');
    let html = '';
    
    catalog.forEach((cat, idx) => {
        const prices = cat.products.map(p => p.price);
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const priceRange = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
        
        html += `
            <div class="category-box" data-category="${cat.id}" onclick="toggleCategory('${cat.id}')">
                <div class="category-name">${cat.name}</div>
                <div class="category-tagline">${cat.tagline}</div>
                <div class="category-price">${priceRange}</div>
            </div>
        `;
        
        html += `
            <div class="dropdown-panel" id="dropdown-${cat.id}">
                <div class="dropdown-header">
                    <div class="dropdown-icon">${CATEGORY_ICONS[cat.id] || '‚öú'}</div>
                    <div>
                        <div class="dropdown-title">${cat.name}</div>
                        <div class="dropdown-desc">${CATEGORY_INFO[cat.id] || cat.tagline}</div>
                    </div>
                </div>
                <div class="products-list">
                    ${cat.products.map(p => `
                        <div class="product-option ${!selectedCapture ? 'disabled' : ''}" 
                             data-product-id="${p.id}"
                             data-product-name="${p.subtitle || p.name}"
                             data-product-price="${p.price}"
                             onclick="selectSize('${p.id}', this)" 
                             title="${p.description || ''}">
                            <div class="product-details">
                                <div class="product-name">${p.subtitle || p.name}</div>
                                <div class="product-subtitle">${p.description || ''}</div>
                            </div>
                            <div class="product-price">$${p.price}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function toggleCategory(categoryId) {
    const boxes = document.querySelectorAll('.category-box');
    const clickedBox = document.querySelector(`[data-category="${categoryId}"]`);
    const dropdown = document.getElementById(`dropdown-${categoryId}`);
    
    document.querySelectorAll('.dropdown-panel').forEach(d => d.classList.remove('open'));
    boxes.forEach(b => b.classList.remove('active'));
    
    if (activeCategory === categoryId) {
        activeCategory = null;
        return;
    }
    
    activeCategory = categoryId;
    clickedBox.classList.add('active');
    dropdown.classList.add('open');
    
    clickedBox.after(dropdown);
    
    const options = dropdown.querySelectorAll('.product-option');
    options.forEach(opt => {
        opt.classList.toggle('disabled', !selectedCapture);
    });
    
    document.getElementById('selectionReminder').classList.toggle('show', !selectedCapture);
    
    setTimeout(() => {
        dropdown.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}


function selectSize(productId, element) {
    if (!selectedCapture) {
        alert('Please select a portrait first');
        return;
    }
    
    // Find product in catalog
    let product = null;
    for (const cat of catalog) {
        const found = cat.products.find(p => p.id === productId);
        if (found) {
            product = found;
            break;
        }
    }
    
    if (!product) return;
    
    selectedProduct = product;
    
    // Update UI - highlight selected size
    document.querySelectorAll('.product-option').forEach(opt => {
        opt.classList.remove('selected-size');
    });
    element.classList.add('selected-size');
    
    // Get aspect ratio for this product
    const aspectRatio = parseAspectFromProduct(product);
    selectedAspectRatio = aspectRatio;
    
    // Update the selected capture card's frame
    const card = document.querySelector('.capture-card.selected');
    if (card) {
        const container = card.querySelector('.image-container');
        const img = container.querySelector('img');
        const sizeBadge = card.querySelector('.size-badge');
        const dragHint = card.querySelector('.drag-hint');
        
        // Update aspect ratio
        container.style.aspectRatio = `1 / ${aspectRatio}`;
        
        // Add size class
        card.classList.add('has-size');
        
        // Update size badge
        const sizeText = (product.subtitle || product.name).match(/[\d.]+\s*[√óx]\s*[\d.]+[""]?/i);
        sizeBadge.textContent = sizeText ? sizeText[0] : product.subtitle || product.name;
        
        // Update drag hint
        dragHint.textContent = '‚áÑ DRAG TO REPOSITION';
        
        // Re-center image for new aspect ratio
        setTimeout(() => {
            centerImageForAspect(container, img, aspectRatio);
        }, 50);
    }
    
    // Show confirm section
    updateConfirmSection();
    
    // Scroll card into view
    if (card) {
        setTimeout(() => {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
}

function updateConfirmSection() {
    const section = document.getElementById('confirmSection');
    const details = document.getElementById('confirmDetails');
    
    if (selectedCapture && selectedProduct) {
        section.classList.add('show');
        details.innerHTML = `
            <strong>${selectedProduct.subtitle || selectedProduct.name}</strong> ‚Äî $${selectedProduct.price}
            <br><span style="font-size: 0.85rem; opacity: 0.7;">Drag image above to adjust framing, then confirm</span>
        `;
    } else {
        section.classList.remove('show');
    }
}

async function confirmPurchase() {
    if (!selectedCapture || !selectedProduct) {
        alert('Please select a portrait and size first');
        return;
    }
    
    const btn = event.currentTarget;
    if (btn.classList.contains('processing')) return;
    
    btn.classList.add('processing');
    btn.textContent = 'Processing...';
    
    try {
        // Get crop position from the selected card
        const card = document.querySelector('.capture-card.selected');
        const container = card.querySelector('.image-container');
        const img = container.querySelector('img');
        
        // Calculate crop data from transform
        const transform = img.style.transform;
        const match = transform.match(/translate\((-?[\d.]+)px,\s*(-?[\d.]+)px\)/);
        const offsetX = match ? parseFloat(match[1]) : 0;
        const offsetY = match ? parseFloat(match[2]) : 0;
        
        const res = await fetch(`${API_BASE}/create-checkout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                productId: selectedProduct.id,
                imageData: selectedCapture.image,
                returnUrl: window.location.href,
                cropData: {
                    offsetX,
                    offsetY,
                    aspectRatio: selectedAspectRatio,
                    containerWidth: container.offsetWidth,
                    containerHeight: container.offsetHeight
                }
            })
        });
        
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Checkout failed');
        }
        
        const { url } = await res.json();
        window.location.href = url;
        
    } catch (e) {
        console.error('Order error:', e);
        alert('Unable to process order: ' + e.message);
        btn.classList.remove('processing');
        btn.textContent = 'Confirm & Checkout';
    }
}

function loadCaptures() {
    const container = document.getElementById('capturesContainer');
    let captureArray = [];
    
    const samplePaths = [
        '/samples/sample1.png',
        '/samples/sample2.png',
        '/samples/sample3.png',
        '/samples/sample4.png',
        '/samples/sample5.png',
        '/samples/sample6.png'
    ];
    
    try {
        const newStored = localStorage.getItem('baroqueCaptureArray');
        if (newStored) {
            captureArray = JSON.parse(newStored);
        } else {
            const oldStored = localStorage.getItem('baroqueCaptures');
            if (oldStored) {
                const oldCaptures = JSON.parse(oldStored);
                captureArray = Object.values(oldCaptures);
            }
        }
    } catch (e) {
        console.error('Error loading captures:', e);
    }
    
    if (captureArray.length === 0) {
        container.innerHTML = `
            <div class="no-captures">
                <p>No portraits captured yet.</p>
                <p style="margin-top: 15px;">
                    <a href="/">Return to the Mirror</a> to create your baroque portrait, 
                    then use the Capture button to save it.
                </p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <h2 class="section-title">‚öú Your Captured Portraits ‚öú</h2>
        <div class="captures-grid"></div>
    `;
    const grid = container.querySelector('.captures-grid');
    
    captureArray.forEach((capture, idx) => {
        const card = document.createElement('div');
        card.className = 'capture-card';
        card.dataset.slot = idx + 1;
        
        const isSample = samplePaths.includes(capture.image);
        if (isSample) {
            card.classList.add('is-sample');
        }
        
        card.onclick = (e) => {
            // Don't trigger if clicking on the image container (drag area)
            if (!e.target.closest('.image-container')) {
                selectCapture(idx + 1, capture);
            }
        };
        
        card.innerHTML = `
            <div class="image-container" data-slot="${idx + 1}">
                <img src="${capture.image}" alt="Portrait ${idx + 1}" draggable="false">
                <div class="size-badge"></div>
                <div class="drag-hint">SELECT A SIZE BELOW</div>
            </div>
            <div class="capture-label">${isSample ? '‚öú Sample' : 'Portrait #' + (idx + 1)}</div>
        `;
        
        grid.appendChild(card);
        
        if (idx === 0) {
            selectCapture(idx + 1, capture);
            card.classList.add('selected');
        }
    });
    
    setTimeout(initDraggableImages, 100);
}


function selectCapture(slot, capture) {
    selectedSlot = slot;
    selectedCapture = capture;
    
    // Reset selected product when changing capture
    selectedProduct = null;
    selectedAspectRatio = null;
    
    document.querySelectorAll('.capture-card').forEach(c => {
        const isSelected = parseInt(c.dataset.slot) === slot;
        c.classList.toggle('selected', isSelected);
        
        // Reset non-selected cards to default aspect
        if (!isSelected) {
            const container = c.querySelector('.image-container');
            container.style.aspectRatio = '3 / 2';
            c.classList.remove('has-size');
        }
    });
    
    // Clear size selection
    document.querySelectorAll('.product-option').forEach(p => {
        p.classList.remove('disabled');
        p.classList.remove('selected-size');
    });
    
    document.getElementById('selectionReminder').classList.remove('show');
    updateConfirmSection();
}

function centerImageForAspect(container, img, aspectRatio) {
    const containerRect = container.getBoundingClientRect();
    const imgWidth = img.naturalWidth || img.offsetWidth;
    const imgHeight = img.naturalHeight || img.offsetHeight;
    
    if (!imgWidth || !imgHeight) return;
    
    const containerRatio = containerRect.width / containerRect.height;
    const imgRatio = imgWidth / imgHeight;
    
    let scaledWidth, scaledHeight, offsetX, offsetY;
    
    if (imgRatio > containerRatio) {
        // Image is wider - fit height, center horizontally
        scaledHeight = containerRect.height;
        scaledWidth = (imgWidth / imgHeight) * scaledHeight;
        offsetX = -(scaledWidth - containerRect.width) / 2;
        offsetY = 0;
        img.style.height = '100%';
        img.style.width = 'auto';
    } else {
        // Image is taller - fit width, center vertically
        scaledWidth = containerRect.width;
        scaledHeight = (imgHeight / imgWidth) * scaledWidth;
        offsetX = 0;
        offsetY = -(scaledHeight - containerRect.height) / 2;
        img.style.width = '100%';
        img.style.height = 'auto';
    }
    
    img.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
}

function initDraggableImages() {
    document.querySelectorAll('.image-container').forEach(container => {
        const img = container.querySelector('img');
        const card = container.closest('.capture-card');
        let isDragging = false;
        let startX, startY, imgStartX, imgStartY;
        
        img.onload = function() {
            centerImageForAspect(container, img, 3/2);
        };
        
        if (img.complete) {
            centerImageForAspect(container, img, 3/2);
        }
        
        container.addEventListener('mousedown', (e) => {
            e.preventDefault();
            
            // Select this capture if not already selected
            const slot = parseInt(container.dataset.slot);
            if (selectedSlot !== slot) {
                const captureArray = JSON.parse(localStorage.getItem('baroqueCaptureArray') || '[]');
                if (captureArray[slot - 1]) {
                    selectCapture(slot, captureArray[slot - 1]);
                    card.classList.add('selected');
                }
            }
            
            isDragging = true;
            card.classList.add('dragging');
            startX = e.clientX;
            startY = e.clientY;
            
            const transform = img.style.transform;
            const match = transform.match(/translate\((-?[\d.]+)px,\s*(-?[\d.]+)px\)/);
            if (match) {
                imgStartX = parseFloat(match[1]);
                imgStartY = parseFloat(match[2]);
            } else {
                imgStartX = 0;
                imgStartY = 0;
            }
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            let newX = imgStartX + deltaX;
            let newY = imgStartY + deltaY;
            
            const containerRect = container.getBoundingClientRect();
            
            const maxX = 0;
            const minX = containerRect.width - img.offsetWidth;
            const maxY = 0;
            const minY = containerRect.height - img.offsetHeight;
            
            newX = Math.min(maxX, Math.max(minX, newX));
            newY = Math.min(maxY, Math.max(minY, newY));
            
            img.style.transform = `translate(${newX}px, ${newY}px)`;
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                card.classList.remove('dragging');
            }
        });
        
        // Touch support
        container.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            
            const slot = parseInt(container.dataset.slot);
            if (selectedSlot !== slot) {
                const captureArray = JSON.parse(localStorage.getItem('baroqueCaptureArray') || '[]');
                if (captureArray[slot - 1]) {
                    selectCapture(slot, captureArray[slot - 1]);
                    card.classList.add('selected');
                }
            }
            
            isDragging = true;
            card.classList.add('dragging');
            startX = touch.clientX;
            startY = touch.clientY;
            
            const transform = img.style.transform;
            const match = transform.match(/translate\((-?[\d.]+)px,\s*(-?[\d.]+)px\)/);
            if (match) {
                imgStartX = parseFloat(match[1]);
                imgStartY = parseFloat(match[2]);
            } else {
                imgStartX = 0;
                imgStartY = 0;
            }
        }, { passive: true });
        
        container.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            const touch = e.touches[0];
            const deltaX = touch.clientX - startX;
            const deltaY = touch.clientY - startY;
            
            let newX = imgStartX + deltaX;
            let newY = imgStartY + deltaY;
            
            const containerRect = container.getBoundingClientRect();
            
            const maxX = 0;
            const minX = containerRect.width - img.offsetWidth;
            const maxY = 0;
            const minY = containerRect.height - img.offsetHeight;
            
            newX = Math.min(maxX, Math.max(minX, newX));
            newY = Math.min(maxY, Math.max(minY, newY));
            
            img.style.transform = `translate(${newX}px, ${newY}px)`;
        }, { passive: true });
        
        container.addEventListener('touchend', () => {
            isDragging = false;
            card.classList.remove('dragging');
        });
    });
}


function renderFallbackCategories() {
    catalog = [
        { id: 'stationery', name: 'Stationery', tagline: 'Cards & Postcards', products: [
            { id: 'postcard-set', subtitle: '4√ó6" Set of 6', description: 'Lustre-finish photo cards on archival stock', price: 18 },
            { id: 'greeting-cards', subtitle: 'A6 Folded with Envelopes (10)', description: 'Fedrigoni gloss paper, 330gsm, blank envelopes', price: 35 }
        ]},
        { id: 'prints', name: 'Fine Art Prints', tagline: 'Archival Gicl√©e', products: [
            { id: 'print-8x10', subtitle: '8√ó10" Archival Gicl√©e', description: 'Enhanced Matte, 200gsm, acid-free', price: 35 },
            { id: 'print-11x14', subtitle: '11√ó14" Archival Gicl√©e', description: 'Enhanced Matte, 200gsm, acid-free', price: 45 },
            { id: 'print-16x20', subtitle: '16√ó20" Archival Gicl√©e', description: 'Enhanced Matte, 200gsm, acid-free', price: 65 },
            { id: 'print-18x24', subtitle: '18√ó24" Archival Gicl√©e', description: 'Enhanced Matte, 200gsm, acid-free', price: 85 },
            { id: 'print-24x36', subtitle: '24√ó36" Archival Gicl√©e', description: 'Enhanced Matte, 200gsm, acid-free', price: 125 }
        ]},
        { id: 'premium-paper', name: 'Premium Papers', tagline: 'Hahnem√ºhle & Watercolor', products: [
            { id: 'hahnemuhle-11x14', subtitle: '11√ó14" German Etching', description: 'Hahnem√ºhle 310gsm cotton rag', price: 75 },
            { id: 'hahnemuhle-16x20', subtitle: '16√ó20" German Etching', description: 'Hahnem√ºhle 310gsm cotton rag', price: 115 },
            { id: 'watercolor-11x14', subtitle: '11√ó14" Cold Press', description: 'Textured watercolor paper', price: 55 },
            { id: 'watercolor-16x20', subtitle: '16√ó20" Cold Press', description: 'Textured watercolor paper', price: 85 }
        ]},
        { id: 'canvas', name: 'Gallery Canvas', tagline: 'Stretched Gicl√©e', products: [
            { id: 'canvas-12x12', subtitle: '12√ó12" Gallery Wrap', description: '1.5" depth, ready to hang', price: 79 },
            { id: 'canvas-16x16', subtitle: '16√ó16" Gallery Wrap', description: '1.5" depth, ready to hang', price: 99 },
            { id: 'canvas-16x20', subtitle: '16√ó20" Gallery Wrap', description: '1.5" depth, ready to hang', price: 119 },
            { id: 'canvas-24x36', subtitle: '24√ó36" Gallery Wrap', description: '1.5" depth, ready to hang', price: 199 }
        ]},
        { id: 'framed', name: 'Framed Prints', tagline: 'Classic & Gallery Frames', products: [
            { id: 'framed-8x10-black', subtitle: '8√ó10" Black Frame', description: 'Solid wood, conservation mat', price: 95 },
            { id: 'framed-11x14-black', subtitle: '11√ó14" Black Frame', description: 'Solid wood, conservation mat', price: 125 },
            { id: 'framed-16x20-black', subtitle: '16√ó20" Black Frame', description: 'Solid wood, conservation mat', price: 185 },
            { id: 'framed-24x36-gold', subtitle: '24√ó36" Gold Ornate', description: 'Baroque-style gilded frame', price: 395 }
        ]},
        { id: 'acrylic', name: 'Acrylic Glass', tagline: 'Face-Mounted Perspex', products: [
            { id: 'acrylic-12x12', subtitle: '12√ó12" HD Acrylic', description: '10mm face-mount, float hardware', price: 129 },
            { id: 'acrylic-16x16', subtitle: '16√ó16" HD Acrylic', description: '10mm face-mount, float hardware', price: 179 },
            { id: 'acrylic-24x24', subtitle: '24√ó24" HD Acrylic', description: '10mm face-mount, float hardware', price: 299 }
        ]},
        { id: 'metal', name: 'Metal Prints', tagline: 'ChromaLuxe HD Aluminum', products: [
            { id: 'metal-8x8', subtitle: '8√ó8" ChromaLuxe', description: 'Dye-sublimated aluminum', price: 69 },
            { id: 'metal-12x12', subtitle: '12√ó12" ChromaLuxe', description: 'Dye-sublimated aluminum', price: 99 },
            { id: 'metal-16x16', subtitle: '16√ó16" ChromaLuxe', description: 'Dye-sublimated aluminum', price: 149 },
            { id: 'metal-24x24', subtitle: '24√ó24" ChromaLuxe', description: 'Dye-sublimated aluminum', price: 299 },
            { id: 'metal-24x36', subtitle: '24√ó36" ChromaLuxe', description: 'Dye-sublimated aluminum', price: 399 }
        ]},
        { id: 'museum', name: 'Museum Collection', tagline: 'Collector Editions', products: [
            { id: 'museum-24x36', subtitle: '24√ó36" Ornate Gold', description: 'Hand-gilded frame, museum glass', price: 595 },
            { id: 'museum-30x40', subtitle: '30√ó40" Collector', description: 'Hand-gilded frame, museum glass', price: 850 }
        ]}
    ];
    renderCategories();
}

document.addEventListener('DOMContentLoaded', () => {
    loadCaptures();
    loadCatalog();
});
</script>
</body>
</html>
