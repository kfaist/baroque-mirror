<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shop Prints - Baroque Mirror</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: #0a0608; 
            color: #fff; 
            font-family: 'Cormorant Garamond', Georgia, serif; 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .content { position: relative; z-index: 10; }
        
        .header { 
            text-align: center; 
            padding: 20px; 
            border-bottom: 1px solid rgba(212,175,55,0.3); 
            background: linear-gradient(180deg, rgba(114,47,55,0.4) 0%, rgba(10,6,8,0.9) 100%);
            backdrop-filter: blur(10px);
        }
        
        .header-top { 
            display: flex; 
            justify-content: center; 
            gap: 40px; 
            margin-bottom: 10px; 
            font-size: 0.8rem; 
            letter-spacing: 4px; 
            color: #f4e4ba; 
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
        }
        
        .header h1 { 
            color: #d4af37; 
            font-size: 2.5rem; 
            margin: 0; 
            letter-spacing: 6px; 
            font-family: 'Cinzel', serif;
            text-shadow: 0 0 30px rgba(212,175,55,0.5);
        }
        
        .header-sub { 
            font-size: 1rem; 
            color: rgba(244,228,186,0.8); 
            margin-top: 8px; 
            font-style: italic;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 15px;
            color: #d4af37;
            text-decoration: none;
            font-family: 'Cinzel', serif;
            letter-spacing: 2px;
            padding: 8px 20px;
            border: 1px solid rgba(212,175,55,0.4);
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            background: rgba(212,175,55,0.2);
            box-shadow: 0 0 20px rgba(212,175,55,0.3);
        }
        
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .section-title {
            text-align: center;
            color: #d4af37;
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            letter-spacing: 4px;
            margin-bottom: 25px;
        }
        
        /* Captures Grid */
        .no-captures {
            text-align: center;
            padding: 40px 20px;
            color: rgba(244,228,186,0.7);
            font-size: 1.1rem;
        }
        
        .no-captures a { color: #d4af37; }
        
        .captures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .capture-card {
            background: rgba(15,10,12,0.85);
            border: 2px solid rgba(212,175,55,0.3);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .capture-card:hover, .capture-card.selected {
            border-color: #d4af37;
            box-shadow: 0 0 25px rgba(212,175,55,0.3);
            transform: translateY(-3px);
        }
        
        .capture-card.selected {
            box-shadow: 0 0 35px rgba(212,175,55,0.5);
        }
        
        .capture-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }
        
        .capture-label {
            padding: 10px;
            text-align: center;
            color: #d4af37;
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
        }
        
        /* Category Grid - 8 boxes with inline dropdowns */
        .categories-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 900px) {
            .categories-container { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 500px) {
            .categories-container { grid-template-columns: 1fr; }
        }
        
        .category-box {
            background: rgba(15,10,12,0.9);
            border: 1px solid rgba(212,175,55,0.4);
            border-radius: 10px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-box:hover {
            border-color: #d4af37;
            background: rgba(212,175,55,0.08);
        }
        
        .category-box.active {
            border-color: #d4af37;
            background: rgba(212,175,55,0.15);
            box-shadow: 0 0 25px rgba(212,175,55,0.2);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .category-name {
            color: #d4af37;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .category-tagline {
            color: rgba(244,228,186,0.7);
            font-size: 0.85rem;
            font-style: italic;
        }
        
        .category-price {
            color: #f4e4ba;
            font-size: 1.1rem;
            margin-top: 10px;
            font-weight: 600;
        }
        
        /* Dropdown panel - spans full width, appears after clicked category */
        .dropdown-panel {
            display: none;
            grid-column: 1 / -1;
            background: rgba(10,6,8,0.95);
            border: 1px solid rgba(212,175,55,0.5);
            border-top: none;
            border-radius: 0 0 12px 12px;
            margin-top: -15px;
            margin-bottom: 15px;
            overflow: hidden;
            animation: slideDown 0.25s ease;
        }
        
        .dropdown-panel.open {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }
        
        .dropdown-header {
            background: rgba(212,175,55,0.1);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(212,175,55,0.3);
        }
        
        .dropdown-title {
            color: #d4af37;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            letter-spacing: 3px;
        }
        
        .dropdown-desc {
            color: rgba(244,228,186,0.8);
            font-size: 0.85rem;
            margin-top: 4px;
        }
        
        .products-list {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .product-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20,15,18,0.8);
            border: 1px solid rgba(212,175,55,0.25);
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .product-option:hover {
            border-color: #d4af37;
            background: rgba(212,175,55,0.1);
        }
        
        .product-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .product-details { flex: 1; }
        
        .product-name {
            color: #f4e4ba;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .product-subtitle {
            color: rgba(244,228,186,0.6);
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        .product-price {
            color: #d4af37;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Cinzel', serif;
        }
        
        /* Selection reminder */
        .selection-reminder {
            text-align: center;
            padding: 15px;
            color: rgba(244,228,186,0.6);
            font-style: italic;
            display: none;
        }
        
        .selection-reminder.show { display: block; }
        
        /* Processing state */
        .processing {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .processing::after {
            content: ' Processing...';
            color: #d4af37;
        }
    </style>
</head>
<body>
    <div class="content">
        <div class="header">
            <div class="header-top">
                <span>Est. MMXXIV</span>
                <span>•</span>
                <span>Giclée Prints</span>
            </div>
            <h1>Shop Prints</h1>
            <div class="header-sub">Museum-quality prints of your AI portrait</div>
            <a href="/" class="back-link">← Back to Mirror</a>
        </div>
        
        <div class="main">
            <div id="capturesContainer"></div>
            
            <div id="selectionReminder" class="selection-reminder">
                ↑ Select a portrait above to purchase
            </div>
            
            <div class="products-section">
                <h2 class="section-title">⚜ Available Print Options ⚜</h2>
                <div id="categoriesContainer" class="categories-container">
                    <!-- Categories and dropdowns populated by JS -->
                </div>
            </div>
        </div>
    </div>

<script>
const API_BASE = 'https://api-production-d80a.up.railway.app';

let catalog = [];
let selectedCapture = null;
let selectedSlot = null;
let activeCategory = null;

const CATEGORY_INFO = {
    'stationery': 'Premium card stock with envelopes included.',
    'prints': 'Acid-free archival paper with 100+ year color guarantee. Ready to frame.',
    'premium-paper': 'Museum-grade substrates for discerning collectors. Cotton rag & specialty textures.',
    'canvas': 'Hand-stretched over solid pine frames, gallery-wrapped edges. Ready to hang.',
    'framed': 'Handmade ash wood frames with conservation mounts and Perspex glaze.',
    'acrylic': 'Face-mounted on 10mm high-gloss perspex with invisible floating mount.',
    'metal': 'ChromaLuxe® HD aluminum. Dye-sublimated, scratch-resistant, vivid colors.',
    'museum': 'Limited collector editions with hand-gilded frames and Tru Vue® museum glass.'
};

async function loadCatalog() {
    try {
        const res = await fetch(`${API_BASE}/catalog`);
        catalog = await res.json();
        renderCategories();
    } catch (e) {
        console.error('Failed to load catalog:', e);
        renderFallbackCategories();
    }
}

function renderCategories() {
    const container = document.getElementById('categoriesContainer');
    let html = '';
    
    catalog.forEach((cat, idx) => {
        const prices = cat.products.map(p => p.price);
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const priceRange = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
        
        // Category box
        html += `
            <div class="category-box" data-category="${cat.id}" onclick="toggleCategory('${cat.id}')">
                <div class="category-name">${cat.name}</div>
                <div class="category-tagline">${cat.tagline}</div>
                <div class="category-price">${priceRange}</div>
            </div>
        `;
        
        // Dropdown panel (hidden by default) - inserted after each category
        // On desktop (4 cols), we insert after positions 3,7 (end of each row)
        // But we'll use JS to position it correctly
        html += `
            <div class="dropdown-panel" id="dropdown-${cat.id}">
                <div class="dropdown-header">
                    <div class="dropdown-title">${cat.name}</div>
                    <div class="dropdown-desc">${CATEGORY_INFO[cat.id] || cat.tagline}</div>
                </div>
                <div class="products-list">
                    ${cat.products.map(p => `
                        <div class="product-option ${!selectedCapture ? 'disabled' : ''}" onclick="orderPrint('${p.id}')" title="${p.description || ''}">
                            <div class="product-details">
                                <div class="product-name">${p.subtitle || p.name}</div>
                                <div class="product-subtitle">${p.description || ''}</div>
                            </div>
                            <div class="product-price">$${p.price}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function toggleCategory(categoryId) {
    const container = document.getElementById('categoriesContainer');
    const boxes = document.querySelectorAll('.category-box');
    const clickedBox = document.querySelector(`[data-category="${categoryId}"]`);
    const dropdown = document.getElementById(`dropdown-${categoryId}`);
    
    // Close all dropdowns and remove active state
    document.querySelectorAll('.dropdown-panel').forEach(d => d.classList.remove('open'));
    boxes.forEach(b => b.classList.remove('active'));
    
    // If clicking same category, just close
    if (activeCategory === categoryId) {
        activeCategory = null;
        return;
    }
    
    // Open clicked dropdown
    activeCategory = categoryId;
    clickedBox.classList.add('active');
    dropdown.classList.add('open');
    
    // Move dropdown to appear right after the clicked box
    clickedBox.after(dropdown);
    
    // Update disabled state based on capture selection
    const options = dropdown.querySelectorAll('.product-option');
    options.forEach(opt => {
        opt.classList.toggle('disabled', !selectedCapture);
    });
    
    // Show reminder if no capture
    document.getElementById('selectionReminder').classList.toggle('show', !selectedCapture);
    
    // Scroll into view
    setTimeout(() => {
        dropdown.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

function loadCaptures() {
    const container = document.getElementById('capturesContainer');
    let captures = {};
    
    try {
        const stored = localStorage.getItem('baroqueCaptures');
        if (stored) captures = JSON.parse(stored);
    } catch (e) {
        console.error('Error loading captures:', e);
    }
    
    const slots = Object.keys(captures);
    
    if (slots.length === 0) {
        container.innerHTML = `
            <div class="no-captures">
                <p>No portraits captured yet.</p>
                <p style="margin-top: 15px;">
                    <a href="/">Return to the Mirror</a> to create your baroque portrait, 
                    then use the Capture button to save it.
                </p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <h2 class="section-title">⚜ Your Captured Portraits ⚜</h2>
        <div class="captures-grid"></div>
    `;
    const grid = container.querySelector('.captures-grid');
    
    slots.forEach((slot, idx) => {
        const capture = captures[slot];
        const card = document.createElement('div');
        card.className = 'capture-card';
        card.dataset.slot = slot;
        card.onclick = () => selectCapture(slot, capture);
        
        card.innerHTML = `
            <img src="${capture.image}" alt="Portrait ${slot}">
            <div class="capture-label">Portrait #${slot}</div>
        `;
        
        grid.appendChild(card);
        
        if (idx === 0) {
            selectCapture(slot, capture);
            card.classList.add('selected');
        }
    });
}

function selectCapture(slot, capture) {
    selectedSlot = slot;
    selectedCapture = capture;
    
    document.querySelectorAll('.capture-card').forEach(c => {
        c.classList.toggle('selected', c.dataset.slot === slot);
    });
    
    document.querySelectorAll('.product-option').forEach(p => {
        p.classList.remove('disabled');
    });
    
    document.getElementById('selectionReminder').classList.remove('show');
}

async function orderPrint(productId) {
    if (!selectedCapture) {
        alert('Please select a portrait first');
        return;
    }
    
    const btn = event.currentTarget;
    if (btn.classList.contains('processing') || btn.classList.contains('disabled')) return;
    
    btn.classList.add('processing');
    
    try {
        const res = await fetch(`${API_BASE}/create-checkout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                productId: productId,
                imageData: selectedCapture.image,
                returnUrl: window.location.href
            })
        });
        
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Checkout failed');
        }
        
        const { url } = await res.json();
        window.location.href = url;
        
    } catch (e) {
        console.error('Order error:', e);
        alert('Unable to process order: ' + e.message);
        btn.classList.remove('processing');
    }
}

function renderFallbackCategories() {
    catalog = [
        { id: 'stationery', name: 'Stationery', tagline: 'Cards & Postcards', products: [
            { id: 'postcard-set', subtitle: '4×6" Set of 6', price: 18 },
            { id: 'greeting-cards', subtitle: 'A6 with Envelopes (10)', price: 35 }
        ]},
        { id: 'prints', name: 'Fine Art Prints', tagline: 'Archival Giclée', products: [
            { id: 'print-8x10', subtitle: '8×10"', price: 35 },
            { id: 'print-11x14', subtitle: '11×14"', price: 45 },
            { id: 'print-16x20', subtitle: '16×20"', price: 65 },
            { id: 'print-18x24', subtitle: '18×24"', price: 85 },
            { id: 'print-24x36', subtitle: '24×36"', price: 125 }
        ]},
        { id: 'premium-paper', name: 'Premium Papers', tagline: 'Hahnemühle & Watercolor', products: [
            { id: 'hahnemuhle-11x14', subtitle: 'German Etching 11×14"', price: 75 },
            { id: 'hahnemuhle-16x20', subtitle: 'German Etching 16×20"', price: 115 },
            { id: 'watercolor-11x14', subtitle: 'Cold Press 11×14"', price: 65 },
            { id: 'watercolor-16x20', subtitle: 'Cold Press 16×20"', price: 95 }
        ]},
        { id: 'canvas', name: 'Gallery Canvas', tagline: 'Stretched Giclée', products: [
            { id: 'canvas-12x12', subtitle: '12×12"', price: 79 },
            { id: 'canvas-16x16', subtitle: '16×16"', price: 99 },
            { id: 'canvas-16x20', subtitle: '16×20"', price: 119 },
            { id: 'canvas-24x36', subtitle: '24×36"', price: 199 }
        ]},
        { id: 'framed', name: 'Framed Prints', tagline: 'Classic & Gallery Frames', products: [
            { id: 'framed-8x10-black', subtitle: '8×10" Black', price: 95 },
            { id: 'framed-11x14-black', subtitle: '11×14" Black', price: 125 },
            { id: 'framed-16x20-black', subtitle: '16×20" Black', price: 185 },
            { id: 'framed-24x36-gold', subtitle: '24×36" Gold', price: 395 }
        ]},
        { id: 'acrylic', name: 'Acrylic Glass', tagline: 'Face-Mounted Perspex', products: [
            { id: 'acrylic-12x12', subtitle: '12×12"', price: 129 },
            { id: 'acrylic-16x16', subtitle: '16×16"', price: 179 },
            { id: 'acrylic-24x24', subtitle: '24×24"', price: 299 }
        ]},
        { id: 'metal', name: 'Metal Prints', tagline: 'ChromaLuxe HD', products: [
            { id: 'metal-8x8', subtitle: '8×8"', price: 69 },
            { id: 'metal-12x12', subtitle: '12×12"', price: 99 },
            { id: 'metal-16x16', subtitle: '16×16"', price: 149 },
            { id: 'metal-24x24', subtitle: '24×24"', price: 299 }
        ]},
        { id: 'museum', name: 'Museum Collection', tagline: 'Collector Editions', products: [
            { id: 'museum-24x36', subtitle: '24×36" Ornate Gold', price: 595 },
            { id: 'museum-30x40', subtitle: '30×40" Collector', price: 850 }
        ]}
    ];
    renderCategories();
}

document.addEventListener('DOMContentLoaded', () => {
    loadCaptures();
    loadCatalog();
});
</script>
</body>
</html>
