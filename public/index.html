<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Baroque Mirror: Self-Portrait - CMA Wonderball 2026</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: #0a0608; 
            color: #fff; 
            font-family: 'Cormorant Garamond', Georgia, serif; 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Background effects */
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        .content { position: relative; z-index: 10; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* ========== HEADER ========== */
        .header { 
            text-align: center; 
            padding: 12px 15px; 
            border-bottom: 1px solid rgba(212,175,55,0.3); 
            background: linear-gradient(180deg, rgba(114,47,55,0.6) 0%, rgba(10,6,8,0.9) 100%); 
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { 
            color: #d4af37; 
            font-size: 1.1rem; 
            letter-spacing: 3px; 
            font-family: 'Cinzel', serif; 
            text-shadow: 0 0 20px rgba(212,175,55,0.5);
        }
        .header-sub { font-size: 0.75rem; color: rgba(244,228,186,0.7); margin-top: 2px; }
        
        /* ========== SESSION BUTTON ========== */
        .session-section {
            padding: 12px 15px;
            background: rgba(15,10,12,0.9);
            border-bottom: 1px solid rgba(212,175,55,0.3);
        }
        .session-btn { 
            width: 100%; 
            padding: 18px 20px; 
            border: 2px solid #d4af37; 
            background: linear-gradient(180deg, rgba(114,47,55,0.9), rgba(74,31,36,0.95)); 
            color: #d4af37; 
            font-size: 1.2rem; 
            cursor: pointer; 
            border-radius: 10px; 
            font-family: 'Cinzel', serif; 
            letter-spacing: 3px; 
            text-transform: uppercase; 
            box-shadow: 0 0 25px rgba(212,175,55,0.2);
            transition: all 0.3s ease;
        }
        .session-btn:hover, .session-btn:active { 
            background: linear-gradient(180deg, #d4af37, #8b6914); 
            color: #0a0608; 
            box-shadow: 0 0 40px rgba(212,175,55,0.5); 
        }
        .session-btn.stop { 
            background: linear-gradient(180deg, rgba(139,0,0,0.9), rgba(74,0,0,0.95)); 
            border-color: #8b0000; 
            color: #ff6b6b; 
        }
        .session-btn.stop:hover { background: linear-gradient(180deg, #8b0000, #4a0000); color: #fff; }
        
        /* ========== VIDEO OUTPUT ========== */
        .video-section {
            position: relative;
            width: 100%;
            background: #000;
        }
        .video-container { 
            position: relative; 
            width: 100%;
            aspect-ratio: 16/9;
            overflow: hidden; 
            box-shadow: 0 0 40px rgba(212,175,55,0.15);
        }
        .output-video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block;
        }
        .frame-overlay { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            pointer-events: none; 
            border: 4px solid transparent; 
            border-image: linear-gradient(135deg, #d4af37, #8b6914, #d4af37) 1; 
            z-index: 5; 
        }
        .fullscreen-btn { 
            position: absolute; top: 10px; right: 10px; 
            width: 36px; height: 36px; 
            border: 1px solid rgba(212,175,55,0.6); 
            background: rgba(10,6,8,0.8); 
            color: #d4af37; 
            cursor: pointer; 
            border-radius: 6px; 
            font-size: 1rem; 
            z-index: 20;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* ========== ACTION ROW ========== */
        .action-row {
            display: flex;
            gap: 10px;
            padding: 12px 15px;
            background: rgba(15,10,12,0.95);
            border-bottom: 1px solid rgba(212,175,55,0.3);
            align-items: stretch;
        }
        .capture-btn-main {
            flex: 0 0 auto;
            width: 70px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border: 2px solid #d4af37;
            background: linear-gradient(180deg, #d4af37, #8b6914);
            color: #0a0608;
            border-radius: 10px;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .capture-btn-main:active { transform: scale(0.97); }
        .capture-btn-main .counter {
            font-size: 0.6rem;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 2px;
        }
        .last-capture {
            flex: 0 0 auto;
            width: 70px;
            height: 60px;
            border: 2px solid rgba(212,175,55,0.5);
            border-radius: 10px;
            background: rgba(0,0,0,0.8);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .last-capture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        .last-capture.has-image img { display: block; }
        .last-capture .placeholder {
            font-size: 0.55rem;
            color: rgba(212,175,55,0.4);
            text-align: center;
            line-height: 1.2;
        }
        .last-capture.has-image .placeholder { display: none; }
        .shop-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60px;
            padding: 8px 12px;
            border: 2px solid #d4af37;
            background: rgba(20,15,18,0.9);
            color: #d4af37;
            border-radius: 10px;
            font-family: 'Cinzel', serif;
            text-decoration: none;
            transition: all 0.3s ease;
            gap: 2px;
        }
        .shop-btn:hover, .shop-btn:active {
            background: linear-gradient(180deg, rgba(212,175,55,0.3), rgba(139,105,20,0.4));
        }
        .shop-btn .line1 { font-size: 0.85rem; font-weight: 700; letter-spacing: 1px; }
        .shop-btn .line2 { font-size: 0.65rem; opacity: 0.8; }
        
        /* ========== CONTROLS SECTION ========== */
        .controls-section {
            padding: 15px;
            background: rgba(15,10,12,0.95);
            flex: 1;
        }
        .control-group {
            margin-bottom: 18px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(212,175,55,0.2);
        }
        .control-group:last-child { border-bottom: none; margin-bottom: 0; }
        .control-group h3 {
            color: #d4af37;
            font-size: 0.85rem;
            font-family: 'Cinzel', serif;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }
        
        /* Prompt Input */
        .prompt-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .prompt-input {
            flex: 1;
            padding: 12px 14px;
            background: rgba(20,15,18,0.9);
            border: 1px solid rgba(212,175,55,0.5);
            border-radius: 8px;
            color: #f4e4ba;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
        }
        .prompt-input::placeholder { color: rgba(244,228,186,0.4); }
        .prompt-input:focus { outline: none; border-color: #d4af37; }
        .prompt-submit {
            padding: 12px 18px;
            border: 2px solid #d4af37;
            background: linear-gradient(180deg, #d4af37, #8b6914);
            color: #0a0608;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .prompt-submit:active { transform: scale(0.97); }
        .dice-btn {
            padding: 12px 14px;
            border: 2px solid rgba(212,175,55,0.5);
            background: rgba(20,15,18,0.9);
            color: #d4af37;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .dice-btn:hover, .dice-btn:active { 
            background: rgba(212,175,55,0.2); 
            border-color: #d4af37; 
        }
        
        /* Style Presets */
        .style-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .style-btn {
            padding: 12px 8px;
            border: 1px solid rgba(212,175,55,0.5);
            background: rgba(20,15,18,0.8);
            color: #f4e4ba;
            cursor: pointer;
            border-radius: 8px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            text-align: center;
        }
        .style-btn .icon { display: block; font-size: 1.3rem; margin-bottom: 4px; }
        .style-btn:hover, .style-btn:active { background: rgba(212,175,55,0.15); border-color: #d4af37; }
        .style-btn.active { 
            background: linear-gradient(135deg, #d4af37, #8b6914); 
            color: #0a0608; 
            font-weight: 700; 
            border-color: #d4af37; 
        }
        
        /* Style statement */
        .style-statement {
            margin-top: 10px;
            padding: 10px 12px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 6px;
            font-size: 0.8rem;
            font-style: italic;
            color: rgba(244,228,186,0.7);
            line-height: 1.4;
        }
        
        /* Mode slider box */
        .mode-box { 
            margin-top: 14px; 
            padding: 12px; 
            background: rgba(0,0,0,0.4); 
            border-radius: 8px;
            border: 1px solid rgba(212,175,55,0.15);
        }
        .mode-labels { 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.7rem; 
            color: rgba(244,228,186,0.7); 
            margin-bottom: 10px; 
        }
        .mode-value { 
            text-align: center; 
            color: #d4af37; 
            font-size: 0.85rem; 
            margin-top: 8px;
            font-weight: 600;
        }
        
        /* Sliders */
        .slider-row { margin-bottom: 14px; }
        .slider-row label { 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.9rem; 
            margin-bottom: 8px; 
            color: rgba(244,228,186,0.9); 
        }
        .slider-row .val { color: #d4af37; font-weight: 700; }
        input[type="range"] { 
            width: 100%; 
            height: 8px; 
            border-radius: 4px; 
            background: linear-gradient(90deg, #722f37, #d4af37); 
            -webkit-appearance: none; 
            cursor: pointer; 
        }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 28px; 
            height: 28px; 
            border-radius: 50%; 
            background: radial-gradient(circle at 30% 30%, #f4e4ba, #d4af37); 
            cursor: pointer; 
            box-shadow: 0 0 10px rgba(212,175,55,0.6); 
        }
        
        /* Webcam preview */
        .webcam-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .webcam-preview video {
            width: 80px;
            height: 60px;
            border: 1px solid rgba(212,175,55,0.4);
            border-radius: 6px;
            object-fit: cover;
        }
        .webcam-preview span {
            font-size: 0.75rem;
            color: rgba(244,228,186,0.6);
        }
        
        /* Log */
        #log { 
            display: block;
            background: rgba(0,0,0,0.6); 
            padding: 10px; 
            height: 80px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 0.65rem; 
            border: 1px solid rgba(212,175,55,0.2); 
            border-radius: 6px; 
            margin-top: 10px; 
        }
        
        /* Statement section */
        .statement-section {
            background: rgba(20, 15, 25, 0.4);
            border: 1px solid rgba(212,175,55,0.25);
            border-radius: 12px;
            padding: 20px !important;
            margin-top: 10px;
        }
        .statement-section p {
            color: rgba(244,228,186,0.85);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 12px;
        }
        .statement-section h3 {
            margin-top: 18px;
        }
        .statement-section h3:first-child {
            margin-top: 0;
        }
        .contact-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(212,175,55,0.3);
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            color: rgba(244,228,186,0.6);
        }
        .contact-label {
            color: rgba(212,175,55,0.8);
            letter-spacing: 2px;
            margin-bottom: 4px;
            font-family: 'Cinzel', serif;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        
        /* ========== DESKTOP STYLES ========== */
        @media (min-width: 900px) {
            .content {
                display: grid;
                grid-template-columns: 320px 1fr 200px;
                grid-template-rows: auto 1fr;
                min-height: 100vh;
            }
            .header {
                grid-column: 1 / -1;
                padding: 15px 20px;
            }
            .header h1 { font-size: 1.8rem; letter-spacing: 5px; }
            .header-sub { font-size: 0.9rem; }
            .session-section {
                grid-column: 1;
                grid-row: 2;
                border-bottom: none;
                border-right: 1px solid rgba(212,175,55,0.3);
            }
            .controls-section {
                grid-column: 1;
                grid-row: 3;
                border-right: 1px solid rgba(212,175,55,0.3);
                overflow-y: auto;
                max-height: calc(100vh - 200px);
            }
            .video-section {
                grid-column: 2;
                grid-row: 2 / 4;
                display: flex;
                flex-direction: column;
                padding: 20px;
            }
            .video-container {
                border-radius: 12px;
                border: 2px solid rgba(212,175,55,0.6);
            }
            .action-row {
                grid-column: 3;
                grid-row: 2 / 4;
                flex-direction: column;
                padding: 20px 15px;
                border-bottom: none;
                border-left: 1px solid rgba(212,175,55,0.3);
            }
            .last-capture {
                width: 100%;
                height: 100px;
            }
            #log { display: block; }
        }
        
        /* Fullscreen */
        .video-container:fullscreen { 
            border-radius: 0; 
            border: none; 
            width: 100vw; 
            height: 100vh; 
        }
        .video-container:fullscreen .output-video { object-fit: contain; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: rgba(212,175,55,0.5); border-radius: 3px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    <canvas id="particleCanvas"></canvas>
    
    <div class="content">
        <!-- 1. HEADER -->
        <div class="header">
            <h1>‚öú BAROQUE MIRROR ‚öú</h1>
            <div class="header-sub">Self-Portrait ‚Ä¢ CMA Wonderball 2026 ‚Ä¢ by Krista Faist</div>
        </div>
        
        <!-- 2. SESSION BUTTON -->
        <div class="session-section">
            <button class="session-btn" id="startBtn">Begin Session ‚öú</button>
            <button class="session-btn stop" id="stopBtn" style="display:none;">End Session ‚ñ¢</button>
        </div>
        
        <!-- 3. VIDEO OUTPUT -->
        <div class="video-section">
            <div class="video-container" id="videoContainer">
                <video class="output-video" id="output" autoplay playsinline muted></video>
                <div class="frame-overlay"></div>
                <button class="fullscreen-btn" id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
            </div>
        </div>
        
        <!-- 4. ACTION ROW -->
        <div class="action-row">
            <button class="capture-btn-main" id="captureBtn" onclick="captureStill()">
                üì∏ Capture
                <span class="counter" id="captureCounter">(0/10)</span>
            </button>
            <div class="last-capture" id="lastCapture">
                <img src="" alt="Last capture" id="lastCaptureImg">
                <span class="placeholder">No<br>captures</span>
            </div>
            <a href="/prints" class="shop-btn">
                <span class="line1">üõí Shop Prints</span>
                <span class="line2">& Mint NFTs</span>
            </a>
        </div>
        
        <!-- 5. CONTROLS -->
        <div class="controls-section">
            <!-- Custom Prompt -->
            <div class="control-group">
                <h3>‚öú Custom Prompt</h3>
                <div class="prompt-row">
                    <button class="dice-btn" id="diceBtn" title="Random prompt">üé≤</button>
                    <input type="text" class="prompt-input" id="customPrompt" placeholder="baroque portrait style...">
                    <button class="prompt-submit" id="promptSubmit">Apply</button>
                </div>
                <div class="slider-row" style="margin-top: 12px;">
                    <label>AI Strength <span class="val" id="strengthVal">25</span></label>
                    <input type="range" id="strengthSlider" min="10" max="50" value="25">
                </div>
            </div>
            
            <!-- Master Style Presets -->
            <div class="control-group">
                <h3>‚öú Master Style</h3>
                <div class="style-presets">
                    <button class="style-btn active" data-style="baroque"><span class="icon">üëë</span>Baroque</button>
                    <button class="style-btn" data-style="rococo"><span class="icon">üéÄ</span>Rococo</button>
                    <button class="style-btn" data-style="caravaggio"><span class="icon">üåë</span>Caravaggio</button>
                    <button class="style-btn" data-style="vermeer"><span class="icon">üí°</span>Vermeer</button>
                    <button class="style-btn" data-style="rembrandt"><span class="icon">üé®</span>Rembrandt</button>
                    <button class="style-btn" data-style="artemisia"><span class="icon">‚öîÔ∏è</span>Artemisia</button>
                </div>
                <div class="style-statement" id="styleStatement">dramatic baroque chiaroscuro, Rubens influence, rich oil textures, gold accents</div>
                
                <!-- Mode Slider: Classical to Caricature -->
                <div class="mode-box">
                    <div class="mode-labels">
                        <span>üé® Classical Oil</span>
                        <span>Revolutionary Satire üìú</span>
                    </div>
                    <input type="range" id="modeSlider" min="0" max="100" value="0">
                    <div class="mode-value" id="modeValue">Pure Classical</div>
                </div>
            </div>
            
            <!-- Transform Controls -->
            <div class="control-group">
                <h3>‚öú Controls</h3>
                <div class="slider-row">
                    <label>Pose <span class="val" id="poseVal">0.30</span></label>
                    <input type="range" id="poseSlider" min="0" max="100" value="30">
                </div>
                <div class="slider-row">
                    <label>Edge <span class="val" id="edgeVal">0.25</span></label>
                    <input type="range" id="edgeSlider" min="0" max="100" value="25">
                </div>
                <div class="slider-row">
                    <label>Depth <span class="val" id="depthVal">0.20</span></label>
                    <input type="range" id="depthSlider" min="0" max="100" value="20">
                </div>
                
                <!-- Webcam preview -->
                <div class="webcam-preview">
                    <video id="local" autoplay muted playsinline></video>
                    <span>Live input</span>
                </div>
            </div>
            
            <div id="log">‚öú Ready...</div>
            
            <!-- About & Statement -->
            <div class="control-group statement-section">
                <h3>‚öú Statement</h3>
                <p>This portrait system is built on an artist-crafted dataset drawn exclusively from public-domain sources. By using only open archives, the model absorbs visual languages rather than personal likenesses ‚Äî motifs from Baroque and Rococo ornament, the humor and distortion of early caricature, and the confrontational spirit of French Revolutionary satire.</p>
                <p>French Revolutionary caricature was uniquely ferocious ‚Äî more violent, more confrontational, and more visually ruthless than anything produced before. It emerged during years when grotesque mockery and extravagant displays of wealth existed in the same rooms.</p>
                
                <h3>‚öú About</h3>
                <p>Historically, jesters entertained elites beneath gilded ceilings. Later, caricature artists appeared at salons and masquerades, where exaggerated portraits were commissioned by the same people who might dismiss them as vulgar in public.</p>
                <p>Wealthy patrons often paid handsomely for grotesque works that the lowest rung of the hoi polloi would judge tacky at a carnival. Taste, ego, and humor have always been unstable companions. AI heightens this tension: fragile ego is still the best subject, and a robust sense of humor remains the only safe compass.</p>
                
                <div class="contact-footer">
                    <span class="contact-label">CONTACT</span>
                    <span>Artist / Technical: kristabluedoor@gmail.com</span>
                    <span>Curatorial / Institutional: chaoscontemporarycraft@gmail.com</span>
                </div>
            </div>
        </div>
    </div>
    
    <canvas id="captureCanvas" style="display:none;"></canvas>

<script>
// ============================================
// DAYDREAM API CONFIGURATION
// ============================================
const API_KEY = 'sk_9bFt6nHdK1T6AXG6knDS3K57u1BTS6xe9FiwqwQW52KoK7UpqBBEYnmPGxFvLJmS';
const API_BASE = 'https://api.daydream.live/v1';
const PIPELINE_ID = 'pip_qpUgXycjWF6YMeSL';

let hls = null;
let inputPC = null;
let localStream = null;
let streamId = null;
let playbackId = null;
let pollTimer = null;
let captureCount = 0;
const MAX_CAPTURES = 10;
let currentStyle = 'baroque';
let customPrompt = '';
let modeValue = 0;

const styles = {
    baroque: { 
        base: 'dramatic baroque chiaroscuro, Rubens influence, rich oil textures, gold accents',
        caricature: 'French Revolution political cartoon, Honor√© Daumier style, satirical exaggeration'
    },
    rococo: { 
        base: 'rococo painting, Fragonard style, pastel palette, soft romantic lighting',
        caricature: 'French Revolution caricature, James Gillray style, mocking aristocracy'
    },
    caravaggio: { 
        base: 'Caravaggio tenebrism, extreme chiaroscuro, single dramatic spotlight',
        caricature: 'Revolutionary propaganda poster, bold contrast, woodcut style'
    },
    vermeer: { 
        base: 'Vermeer Dutch Golden Age, soft window light, pearl luminosity',
        caricature: 'Dutch satirical print, Bruegel grotesque, peasant caricature'
    },
    rembrandt: { 
        base: 'Rembrandt self-portrait style, golden brown palette, impasto brushwork',
        caricature: 'Revolutionary broadsheet illustration, Thomas Rowlandson style'
    },
    artemisia: { 
        base: 'Artemisia Gentileschi style, powerful feminine subjects, dramatic baroque lighting',
        caricature: 'Revolutionary feminist pamphlet, fierce women warriors'
    }
};

const randomPrompts = [
    'Venetian carnival masquerade, golden masks, mysterious candlelight',
    'Dutch still life with tulips and silver vessels, morning light',
    'Spanish court portrait, velvet fabrics, pearl jewelry',
    'Italian Renaissance fresco, angelic figures, celestial clouds',
    'French salon portrait, powdered wigs, silk ribbons, ornate gilt frame',
    'Mannerist elongated figures, swirling drapery, jewel-toned palette',
    'Tenebroso night scene, single candle illumination, dramatic shadows',
    'Byzantine icon style, gold leaf halos, frontal gaze, sacred geometry'
];

function log(msg, type = '') {
    const logEl = document.getElementById('log');
    if (!logEl) return;
    const time = new Date().toLocaleTimeString();
    logEl.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
    logEl.scrollTop = logEl.scrollHeight;
    console.log(msg);
}

function buildPrompt() {
    if (customPrompt) return customPrompt;
    const style = styles[currentStyle];
    if (modeValue < 15) return style.base;
    if (modeValue > 85) return style.caricature;
    const cw = (100 - modeValue) / 100;
    const sw = modeValue / 100;
    return `(${style.base}:${cw.toFixed(2)}), (${style.caricature}:${sw.toFixed(2)})`;
}

async function startSession() {
    log('Starting...', 'info');
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'block';
    
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' }, 
            audio: true 
        });
        document.getElementById('local').srcObject = localStream;
        log('Camera active', 'success');
        
        const createRes = await fetch(`${API_BASE}/streams`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
            body: JSON.stringify({ pipeline_id: PIPELINE_ID })
        });
        
        if (!createRes.ok) throw new Error(`Create failed: ${createRes.status}`);
        
        const data = await createRes.json();
        streamId = data.id;
        playbackId = data.output_playback_id;
        log(`Stream: ${streamId.slice(-8)}`, 'success');
        
        await connectWHIP(data.whip_url);
        log('WebRTC connected', 'success');
        
        await new Promise(r => setTimeout(r, 2000));
        await setParams();
        startPolling();
        
    } catch (err) {
        log(`Error: ${err.message}`, 'error');
        stopSession();
    }
}

async function connectWHIP(whipUrl) {
    inputPC = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    localStream.getTracks().forEach(track => inputPC.addTrack(track, localStream));
    const offer = await inputPC.createOffer();
    await inputPC.setLocalDescription(offer);
    await new Promise(resolve => {
        if (inputPC.iceGatheringState === 'complete') resolve();
        else {
            inputPC.onicegatheringstatechange = () => { if (inputPC.iceGatheringState === 'complete') resolve(); };
            setTimeout(resolve, 3000);
        }
    });
    const res = await fetch(whipUrl, { method: 'POST', headers: { 'Content-Type': 'application/sdp' }, body: inputPC.localDescription.sdp });
    if (!res.ok) throw new Error(`WHIP failed: ${res.status}`);
    await inputPC.setRemoteDescription({ type: 'answer', sdp: await res.text() });
}

async function setParams() {
    const prompt = buildPrompt();
    const negPrompt = modeValue > 50 ? "photorealistic, smooth, digital" : "modern, digital, flat, cartoon, anime, blurry";
    const body = {
        model_id: "streamdiffusion",
        pipeline: "live-video-to-video",
        params: {
            model_id: "stabilityai/sd-turbo",
            prompt: prompt,
            negative_prompt: negPrompt,
            num_inference_steps: parseInt(document.getElementById('strengthSlider').value),
            seed: 42,
            controlnets: [
                { conditioning_scale: document.getElementById('poseSlider').value / 100, enabled: true, model_id: "thibaud/controlnet-sd21-openpose-diffusers", preprocessor: "pose_tensorrt" },
                { conditioning_scale: document.getElementById('edgeSlider').value / 100, enabled: true, model_id: "thibaud/controlnet-sd21-hed-diffusers", preprocessor: "soft_edge" },
                { conditioning_scale: document.getElementById('depthSlider').value / 100, enabled: true, model_id: "thibaud/controlnet-sd21-depth-diffusers", preprocessor: "depth_tensorrt" }
            ]
        }
    };
    try {
        await fetch(`${API_BASE}/streams/${streamId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` }, body: JSON.stringify(body) });
        log('Style applied', 'success');
    } catch (e) { log(`Params: ${e.message}`, 'info'); }
}

function startPolling() {
    let attempts = 0, hlsConnected = false;
    const poll = async () => {
        attempts++;
        try {
            const res = await fetch(`https://livepeer.studio/api/playback/${playbackId}`);
            const data = await res.json();
            if (attempts % 5 === 0) log(`Waiting (${attempts})...`, 'info');
            if (data.meta?.live === 1 && !hlsConnected) {
                log('STREAM LIVE!', 'success');
                const hlsUrl = data.meta?.source?.find(s => s.hrn === 'HLS (TS)')?.url;
                if (hlsUrl) { hlsConnected = true; setTimeout(() => connectHLS(hlsUrl), 1500); }
            }
            if (attempts < 120) pollTimer = setTimeout(poll, hlsConnected ? 5000 : 2000);
        } catch (e) { if (attempts < 120) pollTimer = setTimeout(poll, 3000); }
    };
    pollTimer = setTimeout(poll, 3000);
}

function connectHLS(url) {
    log('Connecting HLS...', 'info');
    const video = document.getElementById('output');
    if (Hls.isSupported()) {
        if (hls) hls.destroy();
        hls = new Hls({ lowLatencyMode: true, liveSyncDuration: 1, liveMaxLatencyDuration: 5, liveDurationInfinity: true });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => { video.play().then(() => log('‚öú ACTIVE!', 'success')).catch(() => { video.muted = true; video.play(); }); });
        hls.on(Hls.Events.ERROR, (e, data) => { if (data.fatal) { if (data.type === Hls.ErrorTypes.NETWORK_ERROR) setTimeout(() => hls.startLoad(), 2000); else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError(); } });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = url; video.addEventListener('loadedmetadata', () => video.play()); }
}

function stopSession() {
    if (pollTimer) clearTimeout(pollTimer);
    if (hls) { hls.destroy(); hls = null; }
    if (inputPC) { inputPC.close(); inputPC = null; }
    if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
    document.getElementById('local').srcObject = null;
    document.getElementById('output').src = '';
    document.getElementById('startBtn').style.display = 'block';
    document.getElementById('stopBtn').style.display = 'none';
    streamId = null; playbackId = null;
    log('Session ended', 'info');
}

function captureStill() {
    const outputVideo = document.getElementById('output');
    const canvas = document.getElementById('captureCanvas');
    const ctx = canvas.getContext('2d');
    if (!outputVideo.videoWidth) { log('No video yet', 'error'); return; }
    canvas.width = Math.min(800, outputVideo.videoWidth);
    canvas.height = canvas.width * (outputVideo.videoHeight / outputVideo.videoWidth);
    ctx.drawImage(outputVideo, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
    captureCount++; if (captureCount > MAX_CAPTURES) captureCount = MAX_CAPTURES;
    document.getElementById('captureCounter').textContent = `(${captureCount}/${MAX_CAPTURES})`;
    document.getElementById('lastCaptureImg').src = dataUrl;
    document.getElementById('lastCapture').classList.add('has-image');
    try {
        const captures = JSON.parse(localStorage.getItem('baroqueMirrorCaptures') || '[]');
        captures.push({ image: dataUrl, timestamp: new Date().toISOString(), style: currentStyle });
        if (captures.length > MAX_CAPTURES) captures.shift();
        localStorage.setItem('baroqueMirrorCaptures', JSON.stringify(captures));
    } catch (e) { localStorage.removeItem('baroqueMirrorCaptures'); }
    log(`Captured (${captureCount}/${MAX_CAPTURES})`, 'success');
}

// Event listeners
document.getElementById('startBtn').addEventListener('click', startSession);
document.getElementById('stopBtn').addEventListener('click', stopSession);
document.getElementById('fullscreenBtn').addEventListener('click', () => { const c = document.getElementById('videoContainer'); if (document.fullscreenElement) document.exitFullscreen(); else c.requestFullscreen(); });
document.getElementById('promptSubmit').addEventListener('click', () => { customPrompt = document.getElementById('customPrompt').value.trim(); document.getElementById('styleStatement').textContent = customPrompt || styles[currentStyle].base; if (streamId) setParams(); log(`Prompt: ${customPrompt || 'preset'}`, 'info'); });
document.getElementById('customPrompt').addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('promptSubmit').click(); });
document.getElementById('diceBtn').addEventListener('click', () => { const p = randomPrompts[Math.floor(Math.random() * randomPrompts.length)]; document.getElementById('customPrompt').value = p; customPrompt = p; document.getElementById('styleStatement').textContent = p; if (streamId) setParams(); log(`Random: ${p}`, 'info'); });
document.querySelectorAll('.style-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentStyle = btn.dataset.style; customPrompt = ''; document.getElementById('customPrompt').value = ''; document.getElementById('styleStatement').textContent = styles[currentStyle].base; if (streamId) setParams(); log(`Style: ${currentStyle}`, 'info'); }); });
document.getElementById('modeSlider').addEventListener('input', function() { modeValue = parseInt(this.value); const labels = ['Pure Classical', 'Mostly Classical', 'Classical Blend', 'Balanced', 'Satirical Blend', 'Mostly Satirical', 'Full Revolutionary']; document.getElementById('modeValue').textContent = labels[Math.min(Math.floor(modeValue / 100 * 7), 6)]; if (streamId) setParams(); });
document.getElementById('strengthSlider').addEventListener('input', e => { document.getElementById('strengthVal').textContent = e.target.value; if (streamId) setParams(); });
document.getElementById('poseSlider').addEventListener('input', e => { document.getElementById('poseVal').textContent = (e.target.value / 100).toFixed(2); if (streamId) setParams(); });
document.getElementById('edgeSlider').addEventListener('input', e => { document.getElementById('edgeVal').textContent = (e.target.value / 100).toFixed(2); if (streamId) setParams(); });
document.getElementById('depthSlider').addEventListener('input', e => { document.getElementById('depthVal').textContent = (e.target.value / 100).toFixed(2); if (streamId) setParams(); });

// Load previous captures
try { const c = JSON.parse(localStorage.getItem('baroqueMirrorCaptures') || '[]'); captureCount = c.length; document.getElementById('captureCounter').textContent = `(${captureCount}/${MAX_CAPTURES})`; if (c.length > 0) { document.getElementById('lastCaptureImg').src = c[c.length - 1].image; document.getElementById('lastCapture').classList.add('has-image'); } } catch (e) {}
log('‚öú Baroque Mirror ready', 'success');
</script>

</body>
</html>
