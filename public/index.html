<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baroque Mirror</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0608; color: #f4e4ba; font-family: 'Georgia', serif; min-height: 100vh; }
        
        .container { display: flex; height: 100vh; }
        
        .video-section { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #input { position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; border: 2px solid #d4af37; border-radius: 8px; z-index: 10; }
        
        .controls { width: 320px; background: rgba(20,15,18,0.95); border-left: 2px solid #d4af37; padding: 20px; overflow-y: auto; }
        
        h1 { color: #d4af37; font-size: 1.5rem; text-align: center; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        
        .section { margin-bottom: 25px; }
        .section-title { color: #d4af37; font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        
        .btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #722f37, #4a1f24); border: 2px solid #d4af37; color: #d4af37; font-size: 1.1rem; cursor: pointer; border-radius: 8px; font-family: Georgia, serif; transition: all 0.3s; }
        .btn:hover { background: linear-gradient(135deg, #d4af37, #8b6914); color: #0a0608; }
        
        .style-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .style-btn { padding: 12px 8px; background: rgba(20,15,18,0.8); border: 1px solid rgba(212,175,55,0.5); color: #f4e4ba; cursor: pointer; border-radius: 6px; font-family: Georgia, serif; font-size: 0.85rem; transition: all 0.3s; }
        .style-btn:hover { border-color: #d4af37; background: rgba(212,175,55,0.15); }
        .style-btn.active { background: linear-gradient(135deg, #d4af37, #8b6914); color: #0a0608; font-weight: bold; }
        
        .prompt-row { display: flex; gap: 8px; }
        .prompt-input { flex: 1; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid rgba(212,175,55,0.4); color: #f4e4ba; border-radius: 6px; font-family: Georgia, serif; font-size: 0.85rem; }
        .dice-btn { padding: 10px 15px; background: rgba(20,15,18,0.8); border: 1px solid rgba(212,175,55,0.5); color: #d4af37; cursor: pointer; border-radius: 6px; font-size: 1.2rem; }
        .dice-btn:hover { background: rgba(212,175,55,0.2); }
        
        .slider-box { margin-bottom: 15px; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: rgba(244,228,186,0.7); margin-bottom: 8px; }
        input[type="range"] { width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #722f37, #d4af37); -webkit-appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #d4af37; cursor: pointer; }
        
        #log { background: #000; padding: 10px; border-radius: 4px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 11px; margin-top: 15px; }
        .log-success { color: #0f0; }
        .log-error { color: #f00; }
        .log-info { color: #88f; }
        
        #startBtn.running { background: linear-gradient(135deg, #2a5a2a, #1a3a1a); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <div class="container">
        <div class="video-section">
            <video id="output" autoplay playsinline></video>
            <video id="input" autoplay muted playsinline></video>
        </div>
        
        <div class="controls">
            <h1>âœ¦ Baroque Mirror âœ¦</h1>
            
            <div class="section">
                <button class="btn" id="startBtn" onclick="start()">BEGIN SESSION</button>
            </div>
            
            <div class="section">
                <div class="section-title">âœ¦ PROMPT</div>
                <div class="prompt-row">
                    <input type="text" id="promptInput" class="prompt-input" placeholder="Enter prompt or roll dice...">
                    <button class="dice-btn" onclick="rollPrompt()">ðŸŽ²</button>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">âœ¦ MASTER STYLE</div>
                <div class="style-grid">
                    <button class="style-btn active" data-style="baroque" onclick="setStyle(this)">Baroque</button>
                    <button class="style-btn" data-style="rococo" onclick="setStyle(this)">Rococo</button>
                    <button class="style-btn" data-style="caravaggio" onclick="setStyle(this)">Caravaggio</button>
                    <button class="style-btn" data-style="vermeer" onclick="setStyle(this)">Vermeer</button>
                    <button class="style-btn" data-style="rembrandt" onclick="setStyle(this)">Rembrandt</button>
                    <button class="style-btn" data-style="artemisia" onclick="setStyle(this)">Artemisia</button>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">âœ¦ TRANSFORM</div>
                <div class="slider-box">
                    <div class="slider-labels"><span>Abstract</span><span>Painting</span></div>
                    <input type="range" id="styleSlider" min="0" max="100" value="70" onchange="updateParams()">
                </div>
                <div class="slider-box">
                    <div class="slider-labels"><span>Smooth</span><span>Depth</span></div>
                    <input type="range" id="depthSlider" min="0" max="100" value="50" onchange="updateParams()">
                </div>
            </div>
            
            <div id="log"></div>
        </div>
    </div>

<script>
const API_KEY = 'sk_wdNUnsKxxwH6v64BHMwHaWT39Mhwk5ZrqZzXDRmAXxxAqCgVGusff2Y8jxiBofuP';
const API_BASE = 'https://api.daydream.live/v1';
const PIPELINE_ID = 'pip_SDXL-turbo-faceid';

const styles = {
    baroque: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Peter_Paul_Rubens_-_Self-Portrait_-_WGA20380.jpg/440px-Peter_Paul_Rubens_-_Self-Portrait_-_WGA20380.jpg',
    rococo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/85/Fragonard_-_swing.jpg/400px-Fragonard_-_swing.jpg',
    caravaggio: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Michelangelo_Caravaggio_065.jpg/440px-Michelangelo_Caravaggio_065.jpg',
    vermeer: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/1665_Girl_with_a_Pearl_Earring.jpg/440px-1665_Girl_with_a_Pearl_Earring.jpg',
    rembrandt: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/Rembrandt_van_Rijn_-_Self-Portrait_-_Google_Art_Project.jpg/440px-Rembrandt_van_Rijn_-_Self-Portrait_-_Google_Art_Project.jpg',
    artemisia: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/Self-portrait_as_the_Allegory_of_Painting_%28La_Pittura%29_-_Artemisia_Gentileschi.jpg/440px-Self-portrait_as_the_Allegory_of_Painting_%28La_Pittura%29_-_Artemisia_Gentileschi.jpg'
};

const prompts = [
    "golden hour sunlight through stained glass",
    "underwater coral reef with bioluminescence",
    "nebula clouds in deep space",
    "autumn leaves swirling in wind",
    "crystal cave with rainbow reflections",
    "northern lights over snow mountains",
    "cherry blossoms falling like rain",
    "fire and embers floating upward",
    "tropical jungle with exotic birds",
    "stormy sea with lightning"
];

let streamId = null;
let currentStyle = 'baroque';
let hls = null;

function log(msg, type = 'info') {
    const el = document.getElementById('log');
    const time = new Date().toLocaleTimeString();
    el.innerHTML += `<div class="log-${type}">[${time}] ${msg}</div>`;
    el.scrollTop = el.scrollHeight;
}

function rollPrompt() {
    const prompt = prompts[Math.floor(Math.random() * prompts.length)];
    document.getElementById('promptInput').value = prompt;
    if (streamId) updateParams();
}

function setStyle(btn) {
    document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentStyle = btn.dataset.style;
    log(`Style: ${currentStyle}`);
    if (streamId) updateParams();
}

async function start() {
    const btn = document.getElementById('startBtn');
    btn.disabled = true;
    btn.textContent = 'Starting...';
    
    try {
        log('Getting camera...');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('input').srcObject = stream;
        log('Camera ready', 'success');
        
        log('Creating AI stream...');
        const styleStrength = document.getElementById('styleSlider').value / 100;
        const depthScale = document.getElementById('depthSlider').value / 100;
        const prompt = document.getElementById('promptInput').value || 'portrait';
        
        const createRes = await fetch(`${API_BASE}/streams`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
            body: JSON.stringify({
                pipeline_id: PIPELINE_ID,
                pipeline_params: {
                    prompt: prompt,
                    ip_adapter: { type: 'faceid', scale: styleStrength, enabled: true },
                    ip_adapter_style_image_url: styles[currentStyle],
                    controlnets: [
                        { enabled: true, model_id: 'xinsir/controlnet-depth-sdxl-1.0', preprocessor: 'depth_tensorrt', conditioning_scale: depthScale, control_guidance_start: 0, control_guidance_end: 1 },
                        { enabled: true, model_id: 'xinsir/controlnet-canny-sdxl-1.0', preprocessor: 'canny', conditioning_scale: 0, control_guidance_start: 0, control_guidance_end: 1 },
                        { enabled: true, model_id: 'xinsir/controlnet-tile-sdxl-1.0', preprocessor: 'feedback', conditioning_scale: 0.1, control_guidance_start: 0, control_guidance_end: 1 }
                    ]
                }
            })
        });
        
        if (!createRes.ok) throw new Error(`Create failed: ${createRes.status}`);
        const data = await createRes.json();
        streamId = data.id;
        log(`Stream: ${streamId}`, 'success');
        
        log('Connecting WebRTC...');
        const pc = new RTCPeerConnection();
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await new Promise(r => { if (pc.iceGatheringState === 'complete') r(); else pc.onicegatheringstatechange = () => { if (pc.iceGatheringState === 'complete') r(); }; setTimeout(r, 5000); });
        
        const whipRes = await fetch(data.whip_url, { method: 'POST', headers: { 'Content-Type': 'application/sdp' }, body: pc.localDescription.sdp });
        if (!whipRes.ok) throw new Error(`WHIP failed: ${whipRes.status}`);
        await pc.setRemoteDescription({ type: 'answer', sdp: await whipRes.text() });
        log('Video connected', 'success');
        
        btn.textContent = 'RUNNING';
        btn.classList.add('running');
        
        // Poll for output
        const playbackId = data.output_playback_id;
        let attempts = 0;
        const poll = async () => {
            attempts++;
            const res = await fetch(`https://livepeer.studio/api/playback/${playbackId}`);
            const pdata = await res.json();
            if (pdata.meta?.live === 1) {
                log('AI Live!', 'success');
                const hlsUrl = pdata.meta.source.find(s => s.hrn === 'HLS (TS)')?.url;
                if (hlsUrl) { connectHLS(hlsUrl); return; }
            }
            if (attempts % 10 === 0) log(`Waiting for AI... (${attempts})`);
            if (attempts < 120) setTimeout(poll, 2000);
        };
        setTimeout(poll, 3000);
        
    } catch (e) {
        log(`Error: ${e.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'BEGIN SESSION';
    }
}

function connectHLS(url) {
    const video = document.getElementById('output');
    if (Hls.isSupported()) {
        hls = new Hls({ lowLatencyMode: true });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => { video.play().catch(() => { video.muted = true; video.play(); }); });
    } else { video.src = url; video.play(); }
}

async function updateParams() {
    if (!streamId) return;
    
    const styleStrength = document.getElementById('styleSlider').value / 100;
    const depthScale = document.getElementById('depthSlider').value / 100;
    const prompt = document.getElementById('promptInput').value || 'portrait';
    
    try {
        const res = await fetch(`${API_BASE}/streams/${streamId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
            body: JSON.stringify({
                params: {
                    prompt: prompt,
                    delta: 0.3,
                    ip_adapter: { type: 'faceid', scale: styleStrength, enabled: true },
                    ip_adapter_style_image_url: styles[currentStyle],
                    controlnets: [
                        { enabled: true, model_id: 'xinsir/controlnet-depth-sdxl-1.0', preprocessor: 'depth_tensorrt', conditioning_scale: depthScale, control_guidance_start: 0, control_guidance_end: 1 },
                        { enabled: true, model_id: 'xinsir/controlnet-canny-sdxl-1.0', preprocessor: 'canny', conditioning_scale: 0, control_guidance_start: 0, control_guidance_end: 1 },
                        { enabled: true, model_id: 'xinsir/controlnet-tile-sdxl-1.0', preprocessor: 'feedback', conditioning_scale: 0.1, control_guidance_start: 0, control_guidance_end: 1 }
                    ]
                }
            })
        });
        if (res.ok) log(`Updated: style=${styleStrength.toFixed(2)} depth=${depthScale.toFixed(2)}`, 'success');
        else log(`Update failed: ${res.status}`, 'error');
    } catch (e) { log(`Error: ${e.message}`, 'error'); }
}
</script>
</body>
</html>
