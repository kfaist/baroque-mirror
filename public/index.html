<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baroque Mirror</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0608; color: #f4e4ba; font-family: 'Georgia', serif; min-height: 100vh; }
        
        .container { display: flex; height: 100vh; }
        
        .video-section { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; background: #000; }
        iframe { width: 100%; height: 100%; border: none; }
        #input { position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; border: 2px solid #d4af37; border-radius: 8px; z-index: 10; }
        
        .controls { width: 320px; background: rgba(20,15,18,0.95); border-left: 2px solid #d4af37; padding: 20px; overflow-y: auto; }
        
        h1 { color: #d4af37; font-size: 1.4rem; text-align: center; margin-bottom: 20px; letter-spacing: 2px; }
        
        .section { margin-bottom: 25px; }
        .section-title { color: #d4af37; font-size: 0.85rem; margin-bottom: 10px; }
        
        .btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #722f37, #4a1f24); border: 2px solid #d4af37; color: #d4af37; font-size: 1.1rem; cursor: pointer; border-radius: 8px; font-family: Georgia, serif; transition: all 0.3s; }
        .btn:hover { background: linear-gradient(135deg, #d4af37, #8b6914); color: #0a0608; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.running { background: linear-gradient(135deg, #2a5a2a, #1a3a1a); }
        
        .style-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .style-btn { padding: 12px 8px; background: rgba(20,15,18,0.8); border: 1px solid rgba(212,175,55,0.5); color: #f4e4ba; cursor: pointer; border-radius: 6px; font-family: Georgia, serif; font-size: 0.85rem; transition: all 0.3s; }
        .style-btn:hover { border-color: #d4af37; background: rgba(212,175,55,0.15); }
        .style-btn.active { background: linear-gradient(135deg, #d4af37, #8b6914); color: #0a0608; font-weight: bold; }
        
        .prompt-row { display: flex; gap: 8px; }
        .prompt-input { flex: 1; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid rgba(212,175,55,0.4); color: #f4e4ba; border-radius: 6px; font-family: Georgia, serif; font-size: 0.85rem; }
        .dice-btn { padding: 10px 15px; background: rgba(20,15,18,0.8); border: 1px solid rgba(212,175,55,0.5); color: #d4af37; cursor: pointer; border-radius: 6px; font-size: 1.2rem; }
        .dice-btn:hover { background: rgba(212,175,55,0.2); }
        
        .slider-box { margin-bottom: 15px; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: rgba(244,228,186,0.7); margin-bottom: 8px; }
        input[type="range"] { width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #722f37, #d4af37); -webkit-appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #d4af37; cursor: pointer; }
        
        #log { background: #000; padding: 10px; border-radius: 4px; height: 80px; overflow-y: auto; font-family: monospace; font-size: 10px; margin-top: 15px; }
        .log-success { color: #0f0; }
        .log-error { color: #f00; }
        .log-info { color: #88f; }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-section">
            <iframe id="output" allow="autoplay"></iframe>
            <video id="input" autoplay muted playsinline></video>
        </div>
        
        <div class="controls">
            <h1>âœ¦ BAROQUE MIRROR âœ¦</h1>
            
            <div class="section">
                <button class="btn" id="startBtn" onclick="start()">BEGIN SESSION</button>
            </div>
            
            <div class="section">
                <div class="section-title">âœ¦ PROMPT</div>
                <div class="prompt-row">
                    <input type="text" id="promptInput" class="prompt-input" placeholder="Enter prompt or roll dice...">
                    <button class="dice-btn" onclick="rollPrompt()">ðŸŽ²</button>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">âœ¦ MASTER STYLE</div>
                <div class="style-grid">
                    <button class="style-btn active" data-style="baroque" onclick="setStyle(this)">Baroque</button>
                    <button class="style-btn" data-style="rococo" onclick="setStyle(this)">Rococo</button>
                    <button class="style-btn" data-style="caravaggio" onclick="setStyle(this)">Caravaggio</button>
                    <button class="style-btn" data-style="vermeer" onclick="setStyle(this)">Vermeer</button>
                    <button class="style-btn" data-style="rembrandt" onclick="setStyle(this)">Rembrandt</button>
                    <button class="style-btn" data-style="vangogh" onclick="setStyle(this)">Van Gogh</button>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">âœ¦ TRANSFORM</div>
                <div class="slider-box">
                    <div class="slider-labels"><span>Abstract</span><span>Realistic</span></div>
                    <input type="range" id="depthSlider" min="0" max="100" value="30" onchange="updateParams()">
                </div>
                <div class="slider-box">
                    <div class="slider-labels"><span>Smooth</span><span>Edges</span></div>
                    <input type="range" id="edgeSlider" min="0" max="100" value="20" onchange="updateParams()">
                </div>
            </div>
            
            <div id="log"></div>
        </div>
    </div>

<script>
const API_KEY = 'sk_wdNUnsKxxwH6v64BHMwHaWT39Mhwk5ZrqZzXDRmAXxxAqCgVGusff2Y8jxiBofuP';
const API_BASE = 'https://api.daydream.live/v1';
const PIPELINE_ID = 'pip_qpUgXycjWF6YMeSL';

const stylePrompts = {
    baroque: 'baroque oil painting, dramatic chiaroscuro, Rubens style, golden light, rich velvet textures',
    rococo: 'rococo painting, pastel colors, Fragonard style, soft light, ornate gilded frame',
    caravaggio: 'Caravaggio painting, dramatic tenebrism, deep shadows, single light source, renaissance',
    vermeer: 'Vermeer painting, soft diffused light, Dutch golden age, pearl earring, domestic scene',
    rembrandt: 'Rembrandt portrait, golden brown tones, impasto technique, dramatic lighting, Dutch master',
    vangogh: 'Van Gogh painting, swirling brushstrokes, vibrant colors, post-impressionist, starry night style'
};

const prompts = [
    "royal portrait with crown and ermine",
    "mythological scene with angels",
    "still life with flowers and fruit",
    "dramatic storm clouds and lightning",
    "golden sunlight through cathedral windows",
    "mysterious figure in candlelight",
    "lush garden with fountains",
    "celestial beings in clouds",
    "rich velvet drapes and gold",
    "ancient ruins at sunset"
];

let streamId = null;
let currentStyle = 'baroque';

function log(msg, type = 'info') {
    const el = document.getElementById('log');
    const time = new Date().toLocaleTimeString();
    el.innerHTML += `<div class="log-${type}">[${time}] ${msg}</div>`;
    el.scrollTop = el.scrollHeight;
    console.log(msg);
}

function rollPrompt() {
    const prompt = prompts[Math.floor(Math.random() * prompts.length)];
    document.getElementById('promptInput').value = prompt;
    if (streamId) updateParams();
}

function setStyle(btn) {
    document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentStyle = btn.dataset.style;
    log(`Style: ${currentStyle}`);
    if (streamId) updateParams();
}

function buildPrompt() {
    const custom = document.getElementById('promptInput').value.trim();
    const style = stylePrompts[currentStyle];
    return custom ? `${custom}, ${style}` : style;
}

async function start() {
    const btn = document.getElementById('startBtn');
    btn.disabled = true;
    btn.textContent = 'Starting...';
    
    try {
        log('Getting camera...');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('input').srcObject = stream;
        log('Camera ready', 'success');
        
        log('Creating stream...');
        const createRes = await fetch(`${API_BASE}/streams`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
            body: JSON.stringify({ pipeline_id: PIPELINE_ID })
        });
        
        if (!createRes.ok) throw new Error(`Create failed: ${createRes.status}`);
        const data = await createRes.json();
        streamId = data.id;
        log(`Stream: ${streamId}`, 'success');
        
        // Set iframe to WebRTC player
        document.getElementById('output').src = `https://lvpr.tv/?v=${data.output_playback_id}&lowLatency=force`;
        
        log('Connecting WebRTC...');
        const pc = new RTCPeerConnection();
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        // Wait for ICE
        await new Promise(r => {
            if (pc.iceGatheringState === 'complete') r();
            else pc.onicegatheringstatechange = () => { if (pc.iceGatheringState === 'complete') r(); };
            setTimeout(r, 3000);
        });
        
        const whipRes = await fetch(data.whip_url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/sdp' },
            body: pc.localDescription.sdp
        });
        if (!whipRes.ok) throw new Error(`WHIP failed: ${whipRes.status}`);
        await pc.setRemoteDescription({ type: 'answer', sdp: await whipRes.text() });
        log('Connected!', 'success');
        
        btn.textContent = 'LIVE';
        btn.classList.add('running');
        
        // Set initial params after short delay
        setTimeout(updateParams, 2000);
        
    } catch (e) {
        log(`Error: ${e.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'BEGIN SESSION';
    }
}

async function updateParams() {
    if (!streamId) return;
    
    const depth = document.getElementById('depthSlider').value / 100;
    const edge = document.getElementById('edgeSlider').value / 100;
    const prompt = buildPrompt();
    
    log(`Updating: depth=${depth.toFixed(2)} edge=${edge.toFixed(2)}`);
    
    try {
        const res = await fetch(`${API_BASE}/streams/${streamId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
            body: JSON.stringify({
                params: {
                    model_id: 'stabilityai/sd-turbo',
                    prompt: prompt,
                    negative_prompt: 'blurry, low quality, modern, photograph, realistic face',
                    num_inference_steps: 50,
                    seed: 42,
                    t_index_list: [0, 8, 17],
                    controlnets: [
                        { enabled: true, model_id: 'thibaud/controlnet-sd21-openpose-diffusers', preprocessor: 'pose_tensorrt', conditioning_scale: 0, control_guidance_start: 0, control_guidance_end: 1 },
                        { enabled: true, model_id: 'thibaud/controlnet-sd21-hed-diffusers', preprocessor: 'soft_edge', conditioning_scale: edge, control_guidance_start: 0, control_guidance_end: 1 },
                        { enabled: true, model_id: 'thibaud/controlnet-sd21-canny-diffusers', preprocessor: 'canny', conditioning_scale: 0, control_guidance_start: 0, control_guidance_end: 1, preprocessor_params: { high_threshold: 200, low_threshold: 100 } },
                        { enabled: true, model_id: 'thibaud/controlnet-sd21-depth-diffusers', preprocessor: 'depth_tensorrt', conditioning_scale: depth, control_guidance_start: 0, control_guidance_end: 1 },
                        { enabled: true, model_id: 'thibaud/controlnet-sd21-color-diffusers', preprocessor: 'passthrough', conditioning_scale: 0.3, control_guidance_start: 0, control_guidance_end: 1 }
                    ]
                }
            })
        });
        if (res.ok) log('Updated!', 'success');
        else log(`Update failed: ${res.status}`, 'error');
    } catch (e) { log(`Error: ${e.message}`, 'error'); }
}
</script>
</body>
</html>
