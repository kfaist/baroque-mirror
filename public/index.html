<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Baroque Mirror | CMA Wonderball 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: #0a0608;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel', 'Times New Roman', serif;
            overflow: hidden;
        }
        
        .frame {
            position: relative;
            width: 90vmin;
            height: 90vmin;
            max-width: 800px;
            max-height: 800px;
        }
        
        .frame::before {
            content: '';
            position: absolute;
            inset: -20px;
            background: linear-gradient(135deg, #d4af37 0%, #8b6914 25%, #d4af37 50%, #8b6914 75%, #d4af37 100%);
            border-radius: 12px;
            z-index: -1;
            box-shadow: 
                0 0 30px rgba(212, 175, 55, 0.5),
                inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        .frame::after {
            content: '';
            position: absolute;
            inset: -10px;
            background: linear-gradient(135deg, #2a1f14 0%, #1a1209 50%, #2a1f14 100%);
            border-radius: 8px;
            z-index: -1;
        }
        
        .mirror {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        #localVideo {
            display: none;
        }
        
        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(10, 6, 8, 0.9);
            transition: opacity 0.5s;
            z-index: 10;
        }
        
        .overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .title {
            color: #d4af37;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .subtitle {
            color: #a08030;
            font-size: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .start-btn {
            padding: 1rem 3rem;
            font-size: 1.2rem;
            font-family: inherit;
            background: linear-gradient(180deg, #722f37 0%, #4a1f24 100%);
            border: 2px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .start-btn:hover {
            background: #d4af37;
            color: #1a1209;
            transform: scale(1.05);
        }
        
        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #d4af37;
            font-size: 0.9rem;
            background: rgba(0,0,0,0.7);
            padding: 8px 16px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .status.visible {
            opacity: 1;
        }
        
        .loading {
            color: #d4af37;
            font-size: 1.2rem;
            display: none;
        }
        
        .loading.visible {
            display: block;
        }
        
        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .corner-ornament {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 3px solid #d4af37;
            opacity: 0.6;
        }
        
        .corner-ornament.tl { top: 10px; left: 10px; border-right: none; border-bottom: none; }
        .corner-ornament.tr { top: 10px; right: 10px; border-left: none; border-bottom: none; }
        .corner-ornament.bl { bottom: 10px; left: 10px; border-right: none; border-top: none; }
        .corner-ornament.br { bottom: 10px; right: 10px; border-left: none; border-top: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <div class="frame">
        <div class="mirror">
            <video id="localVideo" autoplay muted playsinline></video>
            <video id="outputVideo" autoplay playsinline></video>
            
            <div class="corner-ornament tl"></div>
            <div class="corner-ornament tr"></div>
            <div class="corner-ornament bl"></div>
            <div class="corner-ornament br"></div>
            
            <div class="overlay" id="overlay">
                <div class="title">Baroque Mirror</div>
                <div class="subtitle">Step into a masterpiece</div>
                <button class="start-btn" id="startBtn" onclick="start()">Begin Experience</button>
                <div class="loading" id="loading">Preparing your portrait</div>
            </div>
            
            <div class="status" id="status"></div>
        </div>
    </div>

<script>
const API_KEY = 'sk_wdNUnsKxxwH6v64BHMwHaWT39Mhwk5ZrqZzXDRmAXxxAqCgVGusff2Y8jxiBofuP';
const API_BASE = 'https://api.daydream.live/v1';
const PIPELINE_ID = 'pip_SDXL-turbo';

let localStream, inputPC, streamId, playbackId, hls;
let pollTimer;

function showStatus(msg) {
    const status = document.getElementById('status');
    status.textContent = msg;
    status.classList.add('visible');
    setTimeout(() => status.classList.remove('visible'), 3000);
}

async function start() {
    const btn = document.getElementById('startBtn');
    const loading = document.getElementById('loading');
    const overlay = document.getElementById('overlay');
    
    btn.disabled = true;
    btn.style.display = 'none';
    loading.classList.add('visible');
    
    try {
        // Get camera
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 1280, height: 720, frameRate: 30 }, 
            audio: true 
        });
        document.getElementById('localVideo').srcObject = localStream;
        
        // Create stream
        const res = await fetch(`${API_BASE}/streams`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
            body: JSON.stringify({ pipeline_id: PIPELINE_ID })
        });
        
        if (!res.ok) throw new Error(`Stream creation failed`);
        const data = await res.json();
        streamId = data.id;
        playbackId = data.output_playback_id;
        
        // Connect WHIP
        await connectWHIP(data.whip_url);
        
        // Set baroque params
        setTimeout(() => setParams(), 2000);
        
        // Start polling for AI output
        setTimeout(() => startPolling(), 3000);
        
    } catch (e) {
        console.error(e);
        showStatus('Error: ' + e.message);
        btn.disabled = false;
        btn.style.display = 'block';
        loading.classList.remove('visible');
    }
}

async function connectWHIP(whipUrl) {
    inputPC = new RTCPeerConnection({
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    });
    
    inputPC.oniceconnectionstatechange = () => {
        const state = inputPC.iceConnectionState;
        if (state === 'connected') {
            console.log('WHIP connected');
        } else if (state === 'disconnected' || state === 'failed') {
            showStatus('Connection lost - please refresh');
        }
    };
    
    localStream.getTracks().forEach(track => {
        inputPC.addTrack(track, localStream);
    });
    
    const offer = await inputPC.createOffer();
    await inputPC.setLocalDescription(offer);
    
    await new Promise(resolve => {
        if (inputPC.iceGatheringState === 'complete') resolve();
        else {
            inputPC.onicegatheringstatechange = () => {
                if (inputPC.iceGatheringState === 'complete') resolve();
            };
            setTimeout(resolve, 10000);
        }
    });
    
    const res = await fetch(whipUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/sdp' },
        body: inputPC.localDescription.sdp
    });
    
    if (!res.ok) throw new Error('WHIP connection failed');
    
    const answer = await res.text();
    await inputPC.setRemoteDescription({ type: 'answer', sdp: answer });
}

async function setParams() {
    const body = {
        params: {
            model_id: "stabilityai/sdxl-turbo",
            prompt: "baroque oil painting portrait, dramatic chiaroscuro lighting, Rembrandt style, golden hour light, rich oil paint textures, museum masterpiece, ornate gold frame aesthetic",
            negative_prompt: "blurry, low quality, modern, digital, cartoon, anime, sketch",
            num_inference_steps: 4,
            guidance_scale: 0,
            seed: Math.floor(Math.random() * 10000)
        }
    };
    
    try {
        await fetch(`${API_BASE}/streams/${streamId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
            body: JSON.stringify(body)
        });
    } catch (e) {
        console.error('Params error:', e);
    }
}

function startPolling() {
    let pollCount = 0;
    let hlsConnected = false;
    
    const poll = async () => {
        pollCount++;
        
        try {
            const res = await fetch(`https://livepeer.studio/api/playback/${playbackId}`);
            const data = await res.json();
            
            if (data.meta?.live === 1) {
                if (!hlsConnected) {
                    hlsConnected = true;
                    setTimeout(() => {
                        const hlsUrl = data.meta?.source?.find(s => s.hrn === 'HLS (TS)')?.url 
                                  || `https://livepeercdn.studio/hls/${playbackId}/index.m3u8`;
                        connectHLS(hlsUrl);
                    }, 3000);
                }
            }
            
            if (pollCount < 180 && !hlsConnected) {
                pollTimer = setTimeout(poll, 2000);
            }
        } catch (e) {
            if (pollCount < 180) pollTimer = setTimeout(poll, 3000);
        }
    };
    
    pollTimer = setTimeout(poll, 2000);
}

function connectHLS(url) {
    const video = document.getElementById('outputVideo');
    const overlay = document.getElementById('overlay');
    
    if (Hls.isSupported()) {
        if (hls) hls.destroy();
        
        hls = new Hls({
            lowLatencyMode: true,
            liveSyncDuration: 0.5,
            liveMaxLatencyDuration: 2,
            maxBufferLength: 2,
            manifestLoadingTimeOut: 30000,
            manifestLoadingMaxRetry: 10,
            manifestLoadingRetryDelay: 2000
        });
        
        hls.loadSource(url);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
            overlay.classList.add('hidden');
            video.play().catch(() => { video.muted = true; video.play(); });
        });
        
        hls.on(Hls.Events.ERROR, (event, data) => {
            if (data.details === 'manifestLoadError' || data.details === 'manifestParsingError') {
                setTimeout(() => {
                    if (hls) hls.loadSource(url);
                }, 3000);
            } else if (data.fatal && data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                hls.startLoad();
            }
        });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => {
            overlay.classList.add('hidden');
            video.play();
        });
    }
}
</script>
</body>
</html>
