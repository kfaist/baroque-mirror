<!DOCTYPE html>
<html>
<head>
    <title>Baroque Mirror: Self-Portrait - CMA Wonderball 2026</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #0a0608; 
            color: #fff; 
            font-family: 'Cormorant Garamond', Georgia, serif; 
            min-height: 100vh;
            overflow-x: hidden;
        }
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        #pulseOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; opacity: 0; background: radial-gradient(circle at center, rgba(212,175,55,0.3) 0%, transparent 70%); }
        .content { position: relative; z-index: 10; }
        
        .header { 
            text-align: center; 
            padding: 15px 20px; 
            border-bottom: 1px solid rgba(212,175,55,0.3); 
            background: linear-gradient(180deg, rgba(114,47,55,0.4) 0%, rgba(10,6,8,0.7) 100%);
            backdrop-filter: blur(10px);
        }
        .header-top { display: flex; justify-content: center; gap: 40px; margin-bottom: 8px; font-size: 0.75rem; letter-spacing: 4px; color: #f4e4ba; font-family: 'Cinzel', serif; text-transform: uppercase; }
        .header h1 { color: #d4af37; font-size: 2rem; letter-spacing: 5px; font-family: 'Cinzel', serif; text-shadow: 0 0 30px rgba(212,175,55,0.5); }
        .header h1 .subtitle { display: block; font-size: 1.1rem; color: #f4e4ba; letter-spacing: 6px; margin-top: 5px; font-weight: 400; }
        .header-sub { font-size: 0.9rem; color: rgba(244,228,186,0.8); margin-top: 5px; font-style: italic; }
        .header-credit { font-size: 0.8rem; color: #d4af37; margin-top: 3px; font-weight: 600; }
        
        .main { display: grid; grid-template-columns: 380px 1fr 200px; gap: 20px; padding: 20px; max-width: 1800px; margin: 0 auto; }
</style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    <div id="pulseOverlay"></div>
    <canvas id="particleCanvas"></canvas>
    <div class="content">
        <div class="header">
            <div class="header-top"><span>COLUMBUS MUSEUM OF ART</span><span>âšœ</span><span>WONDERBALL 2026</span></div>
            <h1>BAROQUE MIRROR<span class="subtitle">âšœ SELF-PORTRAIT âšœ</span></h1>
            <div class="header-sub">Live AI Art Transformation</div>
            <div class="header-credit">by Krista Faist</div>
        </div>
        <div class="main">
            <div class="controls">
                <!-- BEGIN SESSION Button -->
                <div class="session-section">
                    <button class="session-btn" id="startBtn">BEGIN SESSION âšœ</button>
                    <button class="session-btn stop" id="stopBtn" style="display:none;">â–  END SESSION</button>
                </div>
                
                <!-- Prompt Section with Shuffle -->
                <div class="section">
                    <h3>âšœ Prompt</h3>
                    <div class="prompt-row">
                        <button class="shuffle-btn" id="shuffleBtn" title="Shuffle random prompt">ðŸŽ²</button>
                        <textarea class="prompt-input" id="customPrompt" placeholder="Enter custom style prompt or shuffle for inspiration..."></textarea>
                    </div>
                </div>
                
                <!-- Master Style Grid -->
                <div class="section">
                    <h3>âšœ Master Style</h3>
                    <div class="style-grid">
                        <button class="style-btn active" data-style="baroque">Baroque</button>
                        <button class="style-btn" data-style="rococo">Rococo</button>
                        <button class="style-btn" data-style="caravaggio">Caravaggio</button>
                        <button class="style-btn" data-style="vermeer">Vermeer</button>
                        <button class="style-btn" data-style="rembrandt">Rembrandt</button>
                        <button class="style-btn" data-style="artemisia">Artemisia</button>
                    </div>
                </div>
                
                <!-- Style Mode Slider: Classical vs Satire -->
                <div class="section">
                    <div class="mode-slider-container">
                        <div class="mode-labels">
                            <span class="mode-label left">ðŸŽ¨ Opulent Oil Painting</span>
                            <span class="mode-label right">French Revolution Caricatures ðŸ“œ</span>
                        </div>
                        <input type="range" class="mode-slider" id="modeSlider" min="0" max="100" value="0">
                        <div class="mode-indicator" id="modeIndicator">Pure Classical</div>
                    </div>
                </div>
                
                <!-- Transform Controls -->
                <div class="section">
                    <h3>âšœ Transform Controls</h3>
                    <div class="slider-row">
                        <label>AI Strength <span class="val" id="strengthVal">25</span></label>
                        <input type="range" id="strengthSlider" min="1" max="50" value="25">
                    </div>
                    <div class="slider-row">
                        <label>Prompt Weight <span class="val" id="guidanceVal">7.5</span></label>
                        <input type="range" id="guidanceSlider" min="10" max="200" value="75">
                    </div>
                    <div class="slider-row">
                        <label>Pose Control <span class="val" id="poseVal">0.30</span></label>
                        <input type="range" id="poseSlider" min="0" max="100" value="30">
                    </div>
                    <div class="slider-row">
                        <label>Edge Detail <span class="val" id="edgeVal">0.25</span></label>
                        <input type="range" id="edgeSlider" min="0" max="100" value="25">
                    </div>
                    <div class="slider-row">
                        <label>Depth <span class="val" id="depthVal">0.20</span></label>
                        <input type="range" id="depthSlider" min="0" max="100" value="20">
                    </div>
                </div>
                
                <!-- Audio Reactivity -->
                <div class="section">
                    <h3>âšœ Visual Reactivity</h3>
                    <div class="slider-row">
                        <label>Intensity <span class="val" id="audioIntensityVal">75%</span></label>
                        <input type="range" id="audioIntensitySlider" min="0" max="100" value="75">
                    </div>
                    <div class="slider-row">
                        <label>Pulse <span class="val" id="pulseStrengthVal">60%</span></label>
                        <input type="range" id="pulseStrengthSlider" min="0" max="100" value="60">
                    </div>
                    <div class="audio-section">
                        <h4>ðŸŽµ Audio â†’ Visuals</h4>
                        <div class="audio-meter" id="audioMeter"></div>
                    </div>
                </div>
                
                <div id="log">âšœ Baroque Mirror ready...</div>
            </div>
            
            <!-- Video Output -->
            <div class="output-area">
                <div class="video-container">
                    <video class="output-video" id="output" autoplay playsinline muted></video>
                    <div class="frame-overlay"></div>
                    <div class="webcam-pip"><video id="local" autoplay muted playsinline></video></div>
                </div>
            </div>
            
            <!-- Capture Panel -->
            <div class="capture-panel">
                <h3>âšœ Captures</h3>
                <button class="capture-btn" id="captureBtn">ðŸ“¸ Capture</button>
                <div class="captures-grid" id="capturesGrid"></div>
            </div>
        </div>
    </div>

<style>
        .controls, .capture-panel { 
            background: rgba(15,10,12,0.9); 
            border: 1px solid rgba(212,175,55,0.4); 
            border-radius: 12px; 
            padding: 18px;
            backdrop-filter: blur(15px);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        .capture-panel { padding: 12px; }
        
        .section { margin-bottom: 18px; padding-bottom: 15px; border-bottom: 1px solid rgba(212,175,55,0.2); }
        .section:last-child { border-bottom: none; }
        .section h3 { color: #d4af37; font-size: 0.9rem; margin: 0 0 12px 0; font-family: 'Cinzel', serif; letter-spacing: 2px; }
        
        /* Session Button */
        .session-section { margin-bottom: 18px; padding-bottom: 15px; border-bottom: 1px solid rgba(212,175,55,0.3); }
        .session-btn {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid #d4af37;
            background: linear-gradient(180deg, rgba(114,47,55,0.9), rgba(74,31,36,0.95));
            color: #d4af37;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            letter-spacing: 4px;
            text-transform: uppercase;
            box-shadow: 0 0 25px rgba(212,175,55,0.2);
            transition: all 0.3s;
        }
        .session-btn:hover { background: linear-gradient(180deg, #d4af37, #8b6914); color: #0a0608; box-shadow: 0 0 40px rgba(212,175,55,0.5); transform: translateY(-2px); }
        .session-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .session-btn.stop { background: linear-gradient(180deg, rgba(160,40,40,0.9), rgba(90,20,20,0.95)); border-color: #a03030; color: #fff; }
        
        /* Prompt Row with Shuffle */
        .prompt-row { display: flex; gap: 10px; align-items: flex-start; }
        .shuffle-btn {
            width: 50px;
            height: 50px;
            border: 1px solid rgba(212,175,55,0.5);
            background: rgba(20,15,18,0.9);
            color: #d4af37;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1.4rem;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .shuffle-btn:hover { background: rgba(212,175,55,0.2); border-color: #d4af37; transform: scale(1.1) rotate(15deg); }
        .prompt-input {
            flex: 1;
            min-height: 50px;
            padding: 12px;
            border: 1px solid rgba(212,175,55,0.4);
            background: rgba(0,0,0,0.5);
            color: #f4e4ba;
            border-radius: 8px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.9rem;
            resize: vertical;
        }
        .prompt-input:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 15px rgba(212,175,55,0.3); }
        .prompt-input::placeholder { color: rgba(244,228,186,0.4); font-style: italic; }
        
        /* Style Grid */
        .style-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .style-btn {
            padding: 14px 10px;
            border: 1px solid rgba(212,175,55,0.5);
            background: rgba(20,15,18,0.8);
            color: #f4e4ba;
            cursor: pointer;
            border-radius: 6px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        .style-btn:hover { background: rgba(212,175,55,0.15); border-color: #d4af37; }
        .style-btn.active { background: linear-gradient(135deg, #d4af37, #8b6914); color: #0a0608; font-weight: 700; border-color: #d4af37; }
        
        /* Mode Slider (Classical â†” Satire) */
        .mode-slider-container { padding: 12px; background: rgba(20,15,18,0.6); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; }
        .mode-labels { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .mode-label { font-size: 0.75rem; color: #f4e4ba; opacity: 0.9; }
        .mode-label.left { text-align: left; }
        .mode-label.right { text-align: right; }
        .mode-slider { width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #722f37, #d4af37); -webkit-appearance: none; cursor: pointer; }
        .mode-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #f4e4ba, #d4af37); cursor: grab; box-shadow: 0 0 10px rgba(212,175,55,0.5); }
        .mode-indicator { text-align: center; margin-top: 8px; color: #d4af37; font-size: 0.85rem; font-family: 'Cinzel', serif; letter-spacing: 1px; }
</style>

<style>
        /* Sliders */
        .slider-row { margin-bottom: 12px; }
        .slider-row label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; color: rgba(244,228,186,0.9); }
        .slider-row .val { color: #d4af37; font-weight: 700; }
        input[type="range"] { width: 100%; height: 5px; border-radius: 3px; background: linear-gradient(90deg, #722f37, #d4af37); -webkit-appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #f4e4ba, #d4af37); cursor: pointer; }
        
        /* Audio Section */
        .audio-section { background: rgba(114,47,55,0.2); border: 1px solid rgba(212,175,55,0.3); border-radius: 6px; padding: 10px; margin-top: 10px; }
        .audio-section h4 { color: #d4af37; font-size: 0.75rem; margin-bottom: 8px; font-family: 'Cinzel', serif; }
        .audio-meter { height: 30px; background: rgba(0,0,0,0.5); border-radius: 4px; display: flex; align-items: flex-end; gap: 2px; padding: 4px; }
        .audio-bar { flex: 1; background: linear-gradient(180deg, #d4af37, #722f37, #2a1015); border-radius: 2px; }
        
        /* Video Output */
        .output-area { position: relative; }
        .video-container { position: relative; border: 2px solid rgba(212,175,55,0.6); border-radius: 12px; overflow: hidden; background: #000; }
        .output-video { width: 100%; aspect-ratio: 16/9; background: #000; display: block; }
        .frame-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; border: 6px solid transparent; border-image: linear-gradient(135deg, #d4af37, #8b6914, #d4af37) 1; }
        .webcam-pip { position: absolute; bottom: 15px; left: 15px; width: 200px; border: 2px solid rgba(212,175,55,0.7); border-radius: 6px; background: #000; overflow: hidden; }
        .webcam-pip video { width: 100%; display: block; }
        .webcam-pip::before { content: 'INPUT'; position: absolute; top: 6px; left: 6px; font-size: 0.6rem; color: #d4af37; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 3px; font-family: 'Cinzel', serif; z-index: 5; }
        
        /* Capture Panel */
        .capture-panel h3 { font-size: 0.8rem; margin-bottom: 10px; }
        .capture-btn { width: 100%; padding: 10px; border: 1px solid #d4af37; background: linear-gradient(180deg, rgba(114,47,55,0.8), rgba(74,31,36,0.9)); color: #d4af37; cursor: pointer; border-radius: 6px; font-family: 'Cinzel', serif; font-size: 0.8rem; margin-bottom: 10px; }
        .capture-btn:hover { background: linear-gradient(180deg, #d4af37, #8b6914); color: #0a0608; }
        .captures-grid { display: flex; flex-direction: column; gap: 8px; max-height: calc(100vh - 280px); overflow-y: auto; }
        .capture-thumb { width: 100%; border-radius: 4px; border: 1px solid rgba(212,175,55,0.3); cursor: pointer; transition: all 0.3s; }
        .capture-thumb:hover { border-color: #d4af37; box-shadow: 0 0 10px rgba(212,175,55,0.4); }
        
        /* Log */
        #log { background: rgba(0,0,0,0.6); padding: 8px; height: 60px; overflow-y: auto; font-family: monospace; font-size: 0.6rem; border: 1px solid rgba(212,175,55,0.2); border-radius: 5px; margin-top: 10px; }
        .success { color: #4ade80; } .error { color: #f87171; } .info { color: #60a5fa; }
        
        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: rgba(212,175,55,0.5); border-radius: 3px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
const API_KEY = 'sk_9bFt6nHdK1T6AXG6knDS3K57u1BTS6xe9FiwqwQW52KoK7UpqBBEYnmPGxFvLJmS';
const API_BASE = 'https://api.daydream.live/v1';
const PIPELINE_ID = 'pip_qpUgXycjWF6YMeSL';

let localStream, inputPC, streamId, playbackId, hls, pollTimer;
let audioContext, analyser, audioDataArray;
let currentStyle = 'baroque', customPromptText = '';
let params = { strength: 25, guidance: 7.5, pose: 0.30, edge: 0.25, depth: 0.20 };
let audioParams = { intensity: 0.75, pulseStrength: 0.6 };
let smoothedAudio = new Array(32).fill(0);
let bassLevel = 0, midLevel = 0, highLevel = 0;
let animationId, time = 0, particles = [], goldSpecks = [];
let modeValue = 0; // 0 = pure classical, 100 = pure satire

// Master styles
const styles = {
    baroque: "baroque masterpiece, dramatic chiaroscuro, Rubens, rich oil paint, gold accents",
    rococo: "rococo painting, Fragonard style, pastel palette, soft romantic",
    caravaggio: "Caravaggio tenebrism, extreme chiaroscuro, single spotlight",
    vermeer: "Vermeer Dutch Golden Age, soft window light, pearl luminosity",
    rembrandt: "Rembrandt self-portrait, golden brown palette, impasto, psychological depth",
    artemisia: "Artemisia Gentileschi, powerful feminine, dramatic baroque"
};

// 50 Baroque/Rococo captions (classical opulent style)
const baroqueCaptions = [
    "dramatic chiaroscuro lighting with ornate fabrics and powdered wig detail",
    "opulent rococo ornament in swirling pastel tones",
    "baroque portrait with gold filigree and deep velvet textures",
    "elaborate lace cuffs flowing in soft candlelight",
    "powdered wig architecture with intricate curls and ribbons",
    "ornate brocade clothing rendered in rich painterly detail",
    "dynamic baroque pose illuminated by golden side-light",
    "delicate rococo pastel palette with decorative motifs",
    "carved gilded frame aesthetic with theatrical shadowing",
    "flowing silk fabric reflecting warm candlelight",
    "dramatic baroque composition with sweeping gesture",
    "ornate jewelry and pearls catching soft highlights",
    "richly textured fabrics with elaborate embroidery",
    "rococo frivolity expressed through airy pastel tones",
    "dramatic drapery falling in heavy folds",
    "painterly brush textures emphasizing opulence",
    "baroque theatrical posture with expressive gesture",
    "layered lace and silk rendered in high detail",
    "shimmering gold accents in ornate costume design",
    "ornamental curls and decorative flourishes throughout",
    "romantic rococo atmosphere with soft diffused light",
    "baroque portrait illuminated by intense contrast",
    "swirling powdered wig elements forming decorative shapes",
    "rich velvet shadows contrasted with sparkling jewelry",
    "pastel rococo palette framing an elaborate costume",
    "flowing ribbons and gilded accessories in painterly style",
    "ornate sleeves spreading outward like sculpted fabric",
    "exaggerated baroque gesture with dramatic framing",
    "sumptuous textures emphasizing aristocratic clothing",
    "pale skin tones glowing in soft candlelight",
    "intricate beadwork and embroidery across the garments",
    "rococo lightness expressed in shimmering colors",
    "golden halos of light around decorative wig elements",
    "sculptural drapery cascading with baroque weight",
    "painterly brush strokes creating luxurious textures",
    "swirling composition echoing rococo decorative forms",
    "luminous highlights accenting ornate fabric folds",
    "theatrical pose set within a lavish interior",
    "baroque chiaroscuro emphasizing opulent surfaces",
    "rococo ornament dissolving into decorative abstraction",
    "shimmering satin and lace rendered in fine detail",
    "soft glowing light reflecting on elaborate jewelry",
    "exuberant rococo scrollwork accenting the background",
    "dramatic pose framed by decorative golden textures",
    "ornate curls forming rhythmic patterns throughout",
    "heavy embroidered coats shimmering with metallic thread",
    "warm candlelight softening the edges of rich fabrics",
    "decorative pastel motifs swirling around the figure",
    "dynamic baroque energy expressed in bold lighting",
    "painterly rococo extravagance with intricate costume details"
];
</script>

<script>
// 50 Political-Satire/Caricature captions (French Revolution style)
const satireCaptions = [
    "exaggerated aristocratic figure overwhelmed by symbolic props",
    "satirical caricature with bold outlines and distorted proportions",
    "political cartoon metaphor expressed through absurd posture",
    "figure riding a mountain of paperwork in symbolic satire",
    "character drowning in decorative lace as a comic metaphor",
    "social-climbing absurdity represented through exaggerated costume",
    "caricatured anatomy with expressive features and symbolic items",
    "aristocrat surrounded by yes-men holding mirrors in satire",
    "comedic exaggeration using ornate but impractical fashion",
    "over-decorated wig transforming into satirical architecture",
    "symbolic downfall shown through collapsing decorative props",
    "elaborate costume mocking social pretension through excess",
    "absurdly tall wig sprouting candelabras as visual satire",
    "aristocratic vanity exaggerated through reflective surfaces",
    "cartoonish embellishments amplifying pomp and self-importance",
    "ridiculous footwear featuring miniature staircases for humor",
    "ornamental chaos symbolizing excess and decline",
    "caricatured expression highlighting arrogance and fragility",
    "symbolic animals acting as allegorical companions",
    "decorative overload turning costume into comedic punishment",
    "swirling cartoon lines exaggerating dramatic gesture",
    "satirical props metaphorically capturing misguided ambition",
    "exaggerated facial features echoing political-cartoon tradition",
    "ornate patterns swallowing the character in symbolic excess",
    "character weighed down by absurd decorative accessories",
    "figure surrounded by floating allegorical symbols",
    "vanity portrayed through multiple hand-held mirrors",
    "satirical exaggeration of status through decorative clutter",
    "collapsing wig structure symbolizing pretension",
    "cartoon metaphor rendered through rococo ornament",
    "exaggerated gesture implying pompous self-importance",
    "character lost within an overly elaborate costume design",
    "symbolic objects orbiting the figure in cartoon logic",
    "decorative elements becoming visual commentary",
    "cartoon-style shadowing emphasizing caricature",
    "elaborate costume elements bending under their own absurdity",
    "symbolic rococo props exaggerating personal flaws",
    "ornate throne buckling under excessive decoration",
    "aristocrat surrounded by sycophantic figures in satire",
    "symbolic ribbons representing tangled ambition",
    "exaggerated wig towering beyond reasonable proportion",
    "satirical allegory expressed through absurd ornament",
    "character engulfed by mountains of bureaucratic papers",
    "absurd costume shape reflecting inflated ego",
    "symbolic brooch shaped like a bad idea",
    "cartoon exaggeration emphasizing moral commentary",
    "rococo excess weaponized as humorous critique",
    "aristocrat posed with implausible symbolic props",
    "decorative chaos used as a satirical narrative device",
    "status satire expressed through overloaded costume design"
];

function log(msg, type = '') {
    const div = document.getElementById('log');
    const line = document.createElement('div');
    line.className = type;
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    div.appendChild(line);
    div.scrollTop = div.scrollHeight;
}

// Shuffle - picks based on mode slider position
function shufflePrompt() {
    const mode = modeValue / 100; // 0 to 1
    let caption;
    
    if (mode < 0.33) {
        // Pure classical
        caption = baroqueCaptions[Math.floor(Math.random() * baroqueCaptions.length)];
    } else if (mode > 0.66) {
        // Pure satire
        caption = satireCaptions[Math.floor(Math.random() * satireCaptions.length)];
    } else {
        // Mixed - random from either
        const allCaptions = [...baroqueCaptions, ...satireCaptions];
        caption = allCaptions[Math.floor(Math.random() * allCaptions.length)];
    }
    
    document.getElementById('customPrompt').value = caption;
    customPromptText = caption;
    if (streamId) setParams();
    log(`Shuffled: "${caption.slice(0, 40)}..."`, 'info');
}

// Update mode indicator text
function updateModeIndicator() {
    const indicator = document.getElementById('modeIndicator');
    if (modeValue < 20) indicator.textContent = 'Pure Classical';
    else if (modeValue < 40) indicator.textContent = 'Mostly Classical';
    else if (modeValue < 60) indicator.textContent = 'Balanced Mix';
    else if (modeValue < 80) indicator.textContent = 'Mostly Satirical';
    else indicator.textContent = 'Full Caricature';
}
</script>

<script>
// Background animation
function initGoldSpecksBackground() {
    const canvas = document.getElementById('bgCanvas');
    const ctx = canvas.getContext('2d');
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);
    
    for (let i = 0; i < 150; i++) {
        goldSpecks.push({
            x: Math.random() * canvas.width, y: Math.random() * canvas.height,
            size: Math.random() * 3 + 1, speed: Math.random() * 0.3 + 0.1,
            drift: (Math.random() - 0.5) * 0.5, phase: Math.random() * Math.PI * 2,
            hue: 38 + Math.random() * 15
        });
    }
    
    return function() {
        ctx.fillStyle = 'rgba(10, 6, 8, 1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if (bassLevel > 0.1) {
            const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width*0.5);
            g.addColorStop(0, `rgba(212, 175, 55, ${bassLevel * 0.15})`);
            g.addColorStop(1, 'transparent');
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        goldSpecks.forEach(s => {
            s.y -= s.speed * (1 + bassLevel * 2);
            s.x += s.drift + Math.sin(time * 0.01 + s.phase) * 0.3;
            s.phase += 0.03;
            if (s.y < -10) { s.y = canvas.height + 10; s.x = Math.random() * canvas.width; }
            
            const twinkle = (Math.sin(s.phase) + 1) * 0.5;
            const alpha = 0.3 + twinkle * 0.5 + midLevel * 0.3;
            const size = s.size * (1 + bassLevel * 0.5);
            
            const g = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, size * 4);
            g.addColorStop(0, `hsla(${s.hue}, 80%, ${50 + twinkle * 30}%, ${alpha})`);
            g.addColorStop(0.5, `hsla(${s.hue}, 70%, 40%, ${alpha * 0.3})`);
            g.addColorStop(1, 'transparent');
            ctx.fillStyle = g;
            ctx.beginPath();
            ctx.arc(s.x, s.y, size * 4, 0, Math.PI * 2);
            ctx.fill();
        });
    };
}

function initParticles() {
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);
    
    return function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const target = 75;
        while (particles.length < target) particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, vx: 0, vy: 0, size: Math.random() * 3 + 1, life: 1, hue: 30 + Math.random() * 30 });
        while (particles.length > target) particles.pop();
        
        particles.forEach(p => {
            p.vx += (Math.random() - 0.5) * bassLevel * 3;
            p.vy += (Math.random() - 0.5) * bassLevel * 3;
            p.vx *= 0.98; p.vy *= 0.98;
            p.x += p.vx; p.y += p.vy;
            p.life -= 0.003;
            if (p.life <= 0 || p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
                p.x = Math.random() * canvas.width; p.y = Math.random() * canvas.height;
                p.vx = 0; p.vy = 0; p.life = 1;
            }
            const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size * 3);
            g.addColorStop(0, `hsla(${p.hue}, 80%, 70%, ${p.life * 0.6})`);
            g.addColorStop(1, 'transparent');
            ctx.fillStyle = g;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size * 3, 0, Math.PI * 2);
            ctx.fill();
        });
    };
}

function initAudio(stream) {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.75;
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        audioDataArray = new Uint8Array(analyser.frequencyBinCount);
        const meter = document.getElementById('audioMeter');
        meter.innerHTML = '';
        for (let i = 0; i < 32; i++) { const bar = document.createElement('div'); bar.className = 'audio-bar'; bar.style.height = '4px'; meter.appendChild(bar); }
        log('Audio â†’ Visuals ready', 'success');
    } catch (e) { log(`Audio: ${e.message}`, 'error'); }
}

function updateAudio() {
    if (!analyser) return;
    analyser.getByteFrequencyData(audioDataArray);
    const bc = audioDataArray.length, be = Math.floor(bc * 0.15), me = Math.floor(bc * 0.5);
    let bs = 0, ms = 0, hs = 0;
    for (let i = 0; i < bc; i++) { const v = audioDataArray[i] / 255; if (i < be) bs += v; else if (i < me) ms += v; else hs += v; }
    bassLevel = (bs / be) * audioParams.intensity;
    midLevel = (ms / (me - be)) * audioParams.intensity;
    highLevel = (hs / (bc - me)) * audioParams.intensity;
    for (let i = 0; i < 32; i++) smoothedAudio[i] = smoothedAudio[i] * 0.7 + (audioDataArray[Math.floor(i * bc / 32)] / 255) * 0.3;
    document.querySelectorAll('.audio-bar').forEach((bar, i) => bar.style.height = Math.max(4, smoothedAudio[i] * 26) + 'px');
    document.getElementById('pulseOverlay').style.opacity = bassLevel * audioParams.pulseStrength * 0.7;
}

let drawBg, drawParticles;
function animate() {
    time++;
    updateAudio();
    if (drawBg) drawBg();
    if (drawParticles) drawParticles();
    animationId = requestAnimationFrame(animate);
}
</script>

<script>
// Event handlers
document.getElementById('shuffleBtn').onclick = shufflePrompt;
document.getElementById('modeSlider').oninput = function() { modeValue = +this.value; updateModeIndicator(); };

document.querySelectorAll('.style-btn').forEach(btn => btn.onclick = () => {
    document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentStyle = btn.dataset.style;
    if (streamId) setParams();
});

document.getElementById('strengthSlider').oninput = function() { params.strength = +this.value; document.getElementById('strengthVal').textContent = params.strength; if (streamId) setParams(); };
document.getElementById('guidanceSlider').oninput = function() { params.guidance = this.value / 10; document.getElementById('guidanceVal').textContent = params.guidance.toFixed(1); if (streamId) setParams(); };
document.getElementById('poseSlider').oninput = function() { params.pose = this.value / 100; document.getElementById('poseVal').textContent = params.pose.toFixed(2); if (streamId) setParams(); };
document.getElementById('edgeSlider').oninput = function() { params.edge = this.value / 100; document.getElementById('edgeVal').textContent = params.edge.toFixed(2); if (streamId) setParams(); };
document.getElementById('depthSlider').oninput = function() { params.depth = this.value / 100; document.getElementById('depthVal').textContent = params.depth.toFixed(2); if (streamId) setParams(); };
document.getElementById('audioIntensitySlider').oninput = function() { audioParams.intensity = this.value / 100; document.getElementById('audioIntensityVal').textContent = this.value + '%'; };
document.getElementById('pulseStrengthSlider').oninput = function() { audioParams.pulseStrength = this.value / 100; document.getElementById('pulseStrengthVal').textContent = this.value + '%'; };

document.getElementById('startBtn').onclick = start;
document.getElementById('stopBtn').onclick = stop;

// Capture functionality
let captures = JSON.parse(localStorage.getItem('baroqueCaptures') || '[]');
function renderCaptures() {
    const grid = document.getElementById('capturesGrid');
    grid.innerHTML = '';
    captures.slice(-10).reverse().forEach((src, i) => {
        const img = document.createElement('img');
        img.className = 'capture-thumb';
        img.src = src;
        img.onclick = () => window.open(src, '_blank');
        grid.appendChild(img);
    });
}
document.getElementById('captureBtn').onclick = function() {
    const video = document.getElementById('output');
    if (!video.videoWidth) return;
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const dataUrl = canvas.toDataURL('image/png');
    captures.push(dataUrl);
    if (captures.length > 20) captures = captures.slice(-20);
    localStorage.setItem('baroqueCaptures', JSON.stringify(captures));
    renderCaptures();
    log('Captured!', 'success');
};
renderCaptures();

async function start() {
    document.getElementById('startBtn').disabled = true;
    try {
        log('Camera...', 'info');
        localStream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720, frameRate: 30 }, audio: true });
        document.getElementById('local').srcObject = localStream;
        initAudio(localStream);
        drawBg = initGoldSpecksBackground();
        drawParticles = initParticles();
        if (!animationId) animate();
        
        log('Creating stream...', 'info');
        const res = await fetch(`${API_BASE}/streams`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` }, body: JSON.stringify({ pipeline_id: PIPELINE_ID }) });
        if (!res.ok) throw new Error(`Create: ${res.status}`);
        const data = await res.json();
        streamId = data.id; playbackId = data.output_playback_id;
        log(`Stream: ${streamId.slice(-8)}`, 'success');
        
        await connectWHIP(data.whip_url);
        await new Promise(r => setTimeout(r, 1500));
        await setParams();
        
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';
        startPolling();
    } catch (e) { log(`ERROR: ${e.message}`, 'error'); document.getElementById('startBtn').disabled = false; }
}

async function connectWHIP(url) {
    inputPC = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }], iceCandidatePoolSize: 10 });
    inputPC.oniceconnectionstatechange = () => log(`ICE: ${inputPC.iceConnectionState}`, inputPC.iceConnectionState === 'connected' ? 'success' : 'info');
    localStream.getTracks().forEach(t => inputPC.addTrack(t, localStream));
    const offer = await inputPC.createOffer();
    await inputPC.setLocalDescription(offer);
    await new Promise(r => { if (inputPC.iceGatheringState === 'complete') r(); else { inputPC.onicegatheringstatechange = () => { if (inputPC.iceGatheringState === 'complete') r(); }; setTimeout(r, 2000); } });
    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/sdp' }, body: inputPC.localDescription.sdp });
    if (!res.ok) throw new Error(`WHIP: ${res.status}`);
    await inputPC.setRemoteDescription({ type: 'answer', sdp: await res.text() });
    log('Connected', 'success');
}
</script>

<script>
async function setParams() {
    const prompt = customPromptText || styles[currentStyle];
    const body = { model_id: "streamdiffusion", pipeline: "live-video-to-video", params: { model_id: "stabilityai/sd-turbo", prompt, negative_prompt: "modern, digital, flat, cartoon, blurry", num_inference_steps: params.strength, guidance_scale: params.guidance, seed: 42, controlnets: [
        { conditioning_scale: params.pose, enabled: true, model_id: "thibaud/controlnet-sd21-openpose-diffusers", preprocessor: "pose_tensorrt" },
        { conditioning_scale: params.edge, enabled: true, model_id: "thibaud/controlnet-sd21-hed-diffusers", preprocessor: "soft_edge" },
        { conditioning_scale: params.depth, enabled: true, model_id: "thibaud/controlnet-sd21-depth-diffusers", preprocessor: "depth_tensorrt" }
    ]}};
    try { 
        await fetch(`${API_BASE}/streams/${streamId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` }, body: JSON.stringify(body) }); 
        log(`Style: "${prompt.slice(0,35)}..." S:${params.strength} G:${params.guidance}`, 'info');
    } catch (e) {}
}

function startPolling() {
    let attempts = 0;
    const poll = async () => {
        attempts++;
        try {
            const res = await fetch(`https://livepeer.studio/api/playback/${playbackId}`);
            const data = await res.json();
            if (attempts % 4 === 0) log(`Waiting (${attempts})...`, 'info');
            if (data.meta?.live === 1) { log('LIVE!', 'success'); const url = data.meta?.source?.find(s => s.hrn === 'HLS (TS)')?.url; if (url) connectHLS(url); return; }
        } catch (e) {}
        if (attempts < 60) pollTimer = setTimeout(poll, 1000);
    };
    pollTimer = setTimeout(poll, 1000);
}

function connectHLS(url) {
    const video = document.getElementById('output');
    video.muted = true;
    if (Hls.isSupported()) {
        hls = new Hls({ lowLatencyMode: true, liveSyncDuration: 0.3, liveMaxLatencyDuration: 1.5, liveDurationInfinity: true, maxBufferLength: 2 });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().then(() => log('Streaming!', 'success')));
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = url; video.play(); }
}

function stop() {
    if (pollTimer) clearTimeout(pollTimer);
    if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
    if (inputPC) { inputPC.close(); inputPC = null; }
    if (hls) { hls.destroy(); hls = null; }
    if (audioContext) { audioContext.close(); audioContext = null; }
    if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
    document.getElementById('local').srcObject = null;
    document.getElementById('output').src = '';
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').style.display = 'block';
    document.getElementById('stopBtn').style.display = 'none';
    streamId = null; playbackId = null; particles = []; goldSpecks = [];
    log('Ended', 'info');
}

// Initialize on load
window.addEventListener('load', () => {
    drawBg = initGoldSpecksBackground();
    drawParticles = initParticles();
    function demo() {
        time++;
        bassLevel = 0.08 + Math.sin(time * 0.02) * 0.04;
        midLevel = 0.06 + Math.sin(time * 0.03) * 0.03;
        highLevel = 0.04 + Math.sin(time * 0.04) * 0.02;
        if (drawBg) drawBg();
        if (drawParticles) drawParticles();
        document.getElementById('pulseOverlay').style.opacity = bassLevel * 0.25;
        if (!localStream) animationId = requestAnimationFrame(demo);
    }
    demo();
    updateModeIndicator();
});
</script>
</body>
</html>
